<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéØ Situational Advisory - ClaimNavigatorAI</title>
  <link rel="stylesheet" href="/assets/css/advisory.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-inter">
  <header class="bg-[#0f172a] text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">üéØ Situational Advisory</h1>
    <a href="/app/resource-center.html" class="text-sm underline">‚Üê Resource Center</a>
  </header>

  <main class="p-6 max-w-7xl mx-auto">
    <!-- AI Input Hero Card -->
    <div class="ai-hero-card">
      <div class="ai-hero-content">
        <h2 class="ai-hero-title">Get Personalized AI Advice</h2>
        <p class="ai-hero-subtitle">Describe your claim situation and receive expert guidance tailored to your specific circumstances.</p>
        
        <div class="ai-input-container">
          <textarea 
            id="situationInput" 
            placeholder="Describe your situation (e.g., 'My insurer said my roof leak isn't covered due to wear and tear')"
            class="ai-input"
            rows="2"
          ></textarea>
          <button id="analyzeBtn" class="ai-analyze-btn">
            <span id="analyzeText">Analyze & Advise</span>
            <span id="analyzeSpinner" class="hidden">Analyzing...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- AI Response Display -->
    <div id="aiResponse" class="ai-response-container hidden">
      <div class="ai-response-content">
        <h3 class="ai-response-title">AI Analysis & Recommendations</h3>
        <div id="aiResponseContent" class="ai-response-details"></div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search scenarios..." class="search-input" />
        <select id="categoryFilter" class="category-select">
          <option value="all">All Categories</option>
          <option value="Property">Property Claims</option>
          <option value="Commercial & Business Interruption">Commercial/Business</option>
          <option value="Catastrophe / Disaster">Catastrophe/Disaster</option>
        </select>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
      <button class="category-tab active" data-category="Property">Property Claims</button>
      <button class="category-tab" data-category="Commercial & Business Interruption">Commercial/Business</button>
      <button class="category-tab" data-category="Catastrophe / Disaster">Catastrophe/Disaster</button>
    </div>

    <!-- Scenarios Grid -->
    <div id="scenariosGrid" class="scenarios-grid">
      <!-- Scenarios will be loaded dynamically -->
    </div>
  </main>

  <script>
    let allScenarios = [];
    let filteredScenarios = [];
    let currentCategory = 'Property';

    // Load scenarios from JSON
    async function loadScenarios() {
      try {
        const response = await fetch('/assets/data/advisory.json');
        const data = await response.json();
        allScenarios = data;
        filteredScenarios = data;
        renderScenarios();
      } catch (error) {
        console.error('Error loading scenarios:', error);
        document.getElementById('scenariosGrid').innerHTML = '<p class="text-red-600">Error loading scenarios. Please try again.</p>';
      }
    }

    function renderScenarios() {
      const container = document.getElementById('scenariosGrid');
      container.innerHTML = '';
      
      // Filter by current category
      const categoryScenarios = filteredScenarios.filter(cat => cat.category === currentCategory);
      
      if (categoryScenarios.length === 0) {
        container.innerHTML = '<p class="text-gray-600 text-center py-8">No scenarios found for this category.</p>';
        return;
      }

      categoryScenarios[0].situations.forEach((situation, index) => {
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.innerHTML = `
          <div class="scenario-header">
            <h3 class="scenario-title">${situation.title}</h3>
            <p class="scenario-summary">${situation.summary}</p>
          </div>
          <div class="scenario-actions">
            <button class="view-advice-btn" onclick="toggleAdvice(${index})">
              <span class="advice-text">View Advice</span>
              <span class="advice-icon">‚ñº</span>
            </button>
            <button class="generate-letter-btn" onclick="openLetterModal('${situation.title}', '${situation.document}')">
              Generate Letter
            </button>
          </div>
          <div class="scenario-details hidden" id="details-${index}">
            <div class="details-content">
              <h4>Recommended Action:</h4>
              <p>${situation.summary}</p>
              <h4>Document Type:</h4>
              <p>${situation.document}</p>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function toggleAdvice(index) {
      const details = document.getElementById(`details-${index}`);
      const button = details.previousElementSibling.querySelector('.view-advice-btn');
      const icon = button.querySelector('.advice-icon');
      
      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        icon.textContent = '‚ñ≤';
        button.querySelector('.advice-text').textContent = 'Hide Advice';
      } else {
        details.classList.add('hidden');
        icon.textContent = '‚ñº';
        button.querySelector('.advice-text').textContent = 'View Advice';
      }
    }


    // AI Analysis functionality
    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const situation = document.getElementById('situationInput').value.trim();
      if (!situation) {
        alert('Please describe your situation first.');
        return;
      }

      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeText = document.getElementById('analyzeText');
      const analyzeSpinner = document.getElementById('analyzeSpinner');
      
      // Show loading state
      analyzeText.classList.add('hidden');
      analyzeSpinner.classList.remove('hidden');
      analyzeBtn.disabled = true;

      try {
        const response = await fetch('/netlify/functions/ai-advisory.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ situation })
        });

        const data = await response.json();
        
        if (response.ok) {
          displayAIResponse(data);
        } else {
          throw new Error(data.error || 'Failed to get AI advice');
        }
      } catch (error) {
        console.error('Error getting AI advice:', error);
        alert('Failed to get AI advice. Please try again.');
      } finally {
        // Reset button state
        analyzeText.classList.remove('hidden');
        analyzeSpinner.classList.add('hidden');
        analyzeBtn.disabled = false;
      }
    });

    function displayAIResponse(data) {
      const responseContainer = document.getElementById('aiResponse');
      const responseContent = document.getElementById('aiResponseContent');
      
      // Parse the AI response
      let responseData;
      try {
        responseData = JSON.parse(data);
      } catch (e) {
        // If not JSON, treat as plain text
        responseData = {
          explanation: data,
          nextSteps: 'Please review the advice above.',
          recommendedDocument: 'Appeal Letter',
          exampleText: 'Contact your insurance company for specific guidance.'
        };
      }

      responseContent.innerHTML = `
        <div class="response-section">
          <h4>üìã Next Steps</h4>
          <p>${responseData.nextSteps || 'Review the situation and take appropriate action.'}</p>
        </div>
        <div class="response-section">
          <h4>üí° Explanation</h4>
          <p>${responseData.explanation || 'No explanation provided.'}</p>
        </div>
        <div class="response-section">
          <h4>üìÑ Recommended Document</h4>
          <p>${responseData.recommendedDocument || 'Appeal Letter'}</p>
        </div>
        <div class="response-section">
          <h4>üìù Example Response</h4>
          <p>${responseData.exampleText || 'Contact your insurance company for specific guidance.'}</p>
        </div>
      `;
      
      responseContainer.classList.remove('hidden');
      responseContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Category tab functionality
    document.querySelectorAll('.category-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        // Remove active class from all tabs
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        e.target.classList.add('active');
        
        currentCategory = e.target.dataset.category;
        renderScenarios();
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filteredScenarios = allScenarios.map(category => ({
        ...category,
        situations: category.situations.filter(situation =>
          situation.title.toLowerCase().includes(searchTerm) ||
          situation.summary.toLowerCase().includes(searchTerm)
        )
      }));
      renderScenarios();
    });

    // Category filter functionality
    document.getElementById('categoryFilter').addEventListener('change', (e) => {
      const selectedCategory = e.target.value;
      if (selectedCategory === 'all') {
        filteredScenarios = allScenarios;
      } else {
        filteredScenarios = allScenarios.filter(cat => cat.category === selectedCategory);
      }
      renderScenarios();
    });

    // Initialize the page
    loadScenarios();
  </script>

  <!-- Letter Generation Modal -->
  <div id="letterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Generate Document for This Situation</h2>
          <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Situation:</h3>
          <p id="modalSituation" class="text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Standard Letter Option -->
          <div class="border-2 border-gray-200 rounded-lg p-6 hover:border-blue-300 transition-colors">
            <div class="text-center">
              <div class="text-4xl mb-4">üìÑ</div>
              <h3 class="text-xl font-semibold mb-2">Generate Standard Letter</h3>
              <p class="text-gray-600 mb-4">Use our professional template with your claim information</p>
              <button id="generateStandard" class="w-full bg-[#1e40af] text-white px-6 py-3 rounded-lg hover:bg-[#3b82f6] transition-colors font-medium">
                Generate Standard Letter
              </button>
                    </div>
                </div>
                
          <!-- AI Custom Letter Option -->
          <div class="border-2 border-gray-200 rounded-lg p-6 hover:border-blue-300 transition-colors">
            <div class="text-center">
              <div class="text-4xl mb-4">ü§ñ</div>
              <h3 class="text-xl font-semibold mb-2">Generate Custom AI Letter</h3>
              <p class="text-gray-600 mb-4">AI-powered customization based on your specific situation</p>
              <button id="generateAI" class="w-full bg-[#1e40af] text-white px-6 py-3 rounded-lg hover:bg-[#3b82f6] transition-colors font-medium">
                Generate AI Letter
              </button>
                    </div>
                </div>
            </div>
            
        <!-- AI Custom Input Section (Hidden by default) -->
        <div id="aiInputSection" class="hidden mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Customize Your Letter</h3>
          <div id="customInputFields"></div>
          <div class="mt-4">
            <button id="generateCustom" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
              Generate Custom Letter
            </button>
            </div>
        </div>

        <!-- Letter Preview Section -->
        <div id="letterPreview" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Generated Letter</h3>
            <div class="flex gap-2">
              <button id="downloadPDF" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                üìÑ Download PDF
              </button>
              <button id="copyText" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                üìã Copy Text
              </button>
            </div>
                    </div>
          <div id="letterContent" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto border">
            <!-- Generated letter content will appear here -->
                    </div>
                </div>
                    </div>
                </div>
            </div>
            
  <script>
    // Letter Generation Modal System
    let currentSituation = null;
    let currentDocumentType = null;
    let claimData = {
      name: localStorage.getItem('claimantName') || '',
      policy: localStorage.getItem('policyNumber') || '',
      claim: localStorage.getItem('claimNumber') || '',
      address: localStorage.getItem('propertyAddress') || '',
      email: localStorage.getItem('claimantEmail') || ''
    };

    // Modal functionality
    function showModal(situation, documentType) {
      currentSituation = situation;
      currentDocumentType = documentType;
      
      document.getElementById('modalSituation').textContent = situation;
      document.getElementById('letterModal').classList.remove('hidden');
      document.getElementById('letterPreview').classList.add('hidden');
      document.getElementById('aiInputSection').classList.add('hidden');
    }

    function closeModal() {
      document.getElementById('letterModal').classList.add('hidden');
      document.getElementById('letterPreview').classList.add('hidden');
      document.getElementById('aiInputSection').classList.add('hidden');
    }

    function showAIInputSection() {
      document.getElementById('aiInputSection').classList.remove('hidden');
      createCustomInputFields();
    }

    function createCustomInputFields() {
      const fieldsContainer = document.getElementById('customInputFields');
      const documentType = currentDocumentType;
      
      let inputHTML = '';
      
      switch (documentType) {
        case 'Appeal Letter':
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Disagreement</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="Explain why you disagree with the denial and provide supporting evidence..."></textarea>
            </div>
          `;
          break;
        case 'Demand Letter':
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Amount Owed and Insurer's Offer</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="Describe the amount you believe you're owed, the insurer's offer, and why it's inadequate..."></textarea>
            </div>
          `;
          break;
        case 'Proof of Loss':
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Damage Items Description</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="List specific damaged items, their condition, and estimated values..."></textarea>
            </div>
          `;
          break;
        case 'Notice of Delay Complaint':
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Delay Duration and Impact</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="Describe how long the insurer has delayed, what you've done to follow up, and the impact of the delay..."></textarea>
            </div>
          `;
          break;
        case 'Coverage Clarification Request':
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Coverage Question</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="Describe the specific coverage question or policy term in dispute..."></textarea>
            </div>
          `;
          break;
        default:
          inputHTML = `
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details</label>
              <textarea id="customInput" class="w-full border border-gray-300 rounded-lg p-3" rows="3" 
                placeholder="Provide any additional details to customize your letter..."></textarea>
            </div>
          `;
      }
      
      fieldsContainer.innerHTML = inputHTML;
    }

    async function generateLetter(mode) {
      const userInput = mode === 'ai' ? document.getElementById('customInput').value : '';
      
      try {
        const response = await fetch('/netlify/functions/generate-letter.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            mode: mode,
            situation: currentSituation,
            documentType: currentDocumentType,
            claimData: claimData,
            userInput: userInput
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          displayLetter(data.text);
        } else {
          throw new Error(data.error || 'Failed to generate letter');
        }
      } catch (error) {
        console.error('Error generating letter:', error);
        alert('Failed to generate letter. Please try again.');
      }
    }

    function displayLetter(letterText) {
      document.getElementById('letterContent').textContent = letterText;
      document.getElementById('letterPreview').classList.remove('hidden');
      document.getElementById('aiInputSection').classList.add('hidden');
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "letter" });
      
      // Header block
      doc.setFontSize(10);
      doc.text(`Claimant: ${claimData.name || '[Your Name]'}   Policy: ${claimData.policy || '[Policy Number]'}   Claim: ${claimData.claim || '[Claim Number]'}`, 10, 12);
      doc.text(`Property: ${claimData.address || '[Your Address]'}   Date: ${new Date().toLocaleDateString()}`, 10, 18);
      
      // Add separator line
      doc.line(10, 22, 200, 22);
      
      // Add letter content
      const letterText = document.getElementById('letterContent').textContent;
      const marginX = 10;
      const startY = 28;
      const lines = doc.splitTextToSize(letterText, 190);
      doc.text(lines, marginX, startY);
      
      // Footer watermark
      const footerY = 285;
      doc.setFontSize(9);
      doc.setTextColor(128, 128, 128);
      doc.text("Claim Navigator AI ‚Ä¢ Professional Claim Assistance", 105, footerY, { align: "center" });
      
      // Save PDF
      const fileName = `${currentDocumentType.replace(/\s+/g, '_')}_${claimData.claim || 'claim'}.pdf`;
      doc.save(fileName);
    }

    function copyText() {
      const letterText = document.getElementById('letterContent').textContent;
      navigator.clipboard.writeText(letterText).then(() => {
        alert('Letter text copied to clipboard!');
      }).catch(error => {
        console.error('Error copying text:', error);
        alert('Failed to copy text. Please try again.');
      });
    }

    // Modal event listeners
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('generateStandard').addEventListener('click', () => generateLetter('standard'));
    document.getElementById('generateAI').addEventListener('click', showAIInputSection);
    document.getElementById('generateCustom').addEventListener('click', () => generateLetter('ai'));
    document.getElementById('downloadPDF').addEventListener('click', downloadPDF);
    document.getElementById('copyText').addEventListener('click', copyText);

    // Close modal on outside click
    document.getElementById('letterModal').addEventListener('click', (e) => {
      if (e.target.id === 'letterModal') {
        closeModal();
      }
    });

    // Function to open the letter generation modal
    function openLetterModal(situation, documentType) {
      showModal(situation, documentType);
    }
  </script>
</body>
</html>
