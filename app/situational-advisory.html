<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎯 Situational Advisory - ClaimNavigatorAI</title>
  <link rel="stylesheet" href="/assets/css/advisory.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-inter">
  <header class="bg-[#0f172a] text-white p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-blue-600 rounded"></div>
        <div class="font-semibold">ClaimNavigatorAI</div>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <a href="/app/index.html" class="text-blue-200 hover:text-white transition">Home</a>
        <span class="text-gray-400">></span>
        <span class="text-white font-semibold">Situational Advisory</span>
        <span class="text-gray-400">></span>
        <a href="/app/resource-center.html" class="text-blue-200 hover:text-white transition">Resource Center</a>
      </nav>
    </div>
  </header>

  <main class="p-6 max-w-7xl mx-auto">
    <!-- AI Input Hero Card -->
    <div class="ai-hero-card">
      <div class="ai-hero-content">
        <h2 class="ai-hero-title">Get Personalized AI Advice</h2>
        <p class="ai-hero-subtitle">Describe your claim situation and receive expert guidance tailored to your specific circumstances.</p>
        
        <div class="ai-input-container">
          <textarea 
            id="situationInput" 
            placeholder="Describe your situation (e.g., 'My insurer said my roof leak isn't covered due to wear and tear')"
            class="ai-input"
            rows="2"
          ></textarea>
          <button id="analyzeBtn" class="ai-analyze-btn">
            <span id="analyzeText">Analyze & Advise</span>
            <span id="analyzeSpinner" class="hidden">Analyzing...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- AI Response Display -->
    <div id="aiResponse" class="ai-response-container hidden">
      <div class="ai-response-content">
        <h3 class="ai-response-title">AI Analysis & Recommendations</h3>
        <div id="aiResponseContent" class="ai-response-details"></div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search scenarios..." class="search-input" />
        <select id="categoryFilter" class="category-select">
          <option value="all">All Categories</option>
          <option value="Property">Property Claims</option>
          <option value="Commercial & Business Interruption">Commercial/Business</option>
          <option value="Catastrophe / Disaster">Catastrophe/Disaster</option>
        </select>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
      <button class="category-tab active" data-category="all">All Claims</button>
      <button class="category-tab" data-category="Property">Property Claims</button>
      <button class="category-tab" data-category="Commercial & Business Interruption">Commercial/Business</button>
      <button class="category-tab" data-category="Catastrophe / Disaster">Catastrophe/Disaster</button>
    </div>

    <!-- Scenarios Grid -->
    <div id="scenariosGrid" class="scenarios-grid">
      <!-- Scenarios will be loaded dynamically -->
    </div>
  </main>

  <script>
    let allScenarios = [];
    let filteredScenarios = [];
    let currentCategory = 'all';

    // Function to navigate to document generator page
    function openLetterModal(situation, documentType) {
      console.log('openLetterModal called with:', situation, documentType);
      // Map document types to document IDs
      const documentMapping = {
        'Appeal Letter': 'appeal-letter',
        'Demand Letter': 'demand-letter',
        'Notice of Delay Complaint': 'delay-complaint',
        'Coverage Clarification Request': 'coverage-clarification',
        'Proof of Loss': 'proof-of-loss',
        'Damage Assessment': 'damage-assessment',
        'Expert Opinion Request': 'expert-opinion-request',
        'Business Interruption Claim': 'business-interruption-claim',
        'Proof of Repairs Submission': 'proof-of-repairs',
        'Notice of Claim': 'notice-of-claim',
        'Settlement Offer': 'settlement-offer',
        'Regulatory Complaint': 'regulatory-complaint',
        'Appraisal Request': 'appraisal-request',
        'Evidence Log': 'evidence-log',
        'Expense Reimbursement': 'expense-reimbursement',
        'Photograph Log': 'photograph-log',
        'Out-of-Pocket Expenses': 'out-of-pocket-log',
        'ROM Estimate': 'rom-estimate',
        'Comparative Estimates': 'comparative-estimates',
        'Document Index': 'document-index'
      };

      // Get the document ID, fallback to appeal-letter if not found
      const documentId = documentMapping[documentType] || 'appeal-letter';

      // Navigate to letter generator with document type and situation
      console.log('Navigating to:', `/app/letter-generator.html?type=${encodeURIComponent(documentType)}&situation=${encodeURIComponent(situation)}`);
      window.location.href = `/app/letter-generator.html?type=${encodeURIComponent(documentType)}&situation=${encodeURIComponent(situation)}`;
    }

    // Load scenarios from JSON
    async function loadScenarios() {
      try {
        const response = await fetch('/assets/data/advisory.json');
        const data = await response.json();
        allScenarios = data;
        filteredScenarios = data;
        renderScenarios();
      } catch (error) {
        console.error('Error loading scenarios:', error);
        document.getElementById('scenariosGrid').innerHTML = '<p class="text-red-600">Error loading scenarios. Please try again.</p>';
      }
    }

    function renderScenarios() {
      const container = document.getElementById('scenariosGrid');
      container.innerHTML = '';
      
      let scenariosToShow = [];
      
      if (currentCategory === 'all') {
        // Show all scenarios from all categories
        filteredScenarios.forEach(category => {
          scenariosToShow = scenariosToShow.concat(category.situations);
        });
      } else {
        // Filter by current category
        const categoryScenarios = filteredScenarios.filter(cat => cat.category === currentCategory);
        if (categoryScenarios.length > 0) {
          scenariosToShow = categoryScenarios[0].situations;
        }
      }
      
      if (scenariosToShow.length === 0) {
        container.innerHTML = '<p class="text-gray-600 text-center py-8">No scenarios found for this category.</p>';
        return;
      }

      scenariosToShow.forEach((situation, index) => {
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.innerHTML = `
          <div class="scenario-header">
            <h3 class="scenario-title">${situation.title}</h3>
            <p class="scenario-summary">${situation.summary}</p>
          </div>
          <div class="scenario-actions">
            <button class="view-advice-btn" onclick="toggleAdvice(${index})">
              <span class="advice-text">View Advice</span>
              <span class="advice-icon">▼</span>
            </button>
            <button class="generate-letter-btn" onclick="openLetterModal('${situation.title}', '${situation.document}')">
              Generate Letter
            </button>
          </div>
          <div class="scenario-details hidden" id="details-${index}">
            <div class="details-content">
              <h4>Recommended Action:</h4>
              <p>${situation.summary}</p>
              <h4>Document Type:</h4>
              <p>${situation.document}</p>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function toggleAdvice(index) {
      const details = document.getElementById(`details-${index}`);
      const button = details.previousElementSibling.querySelector('.view-advice-btn');
      const icon = button.querySelector('.advice-icon');
      
      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        icon.textContent = '▲';
        button.querySelector('.advice-text').textContent = 'Hide Advice';
      } else {
        details.classList.add('hidden');
        icon.textContent = '▼';
        button.querySelector('.advice-text').textContent = 'View Advice';
      }
    }


    // AI Analysis functionality
    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const situation = document.getElementById('situationInput').value.trim();
      if (!situation) {
        alert('Please describe your situation first.');
        return;
      }

      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeText = document.getElementById('analyzeText');
      const analyzeSpinner = document.getElementById('analyzeSpinner');
      
      // Show loading state
      analyzeText.classList.add('hidden');
      analyzeSpinner.classList.remove('hidden');
      analyzeBtn.disabled = true;

      try {
        const response = await fetch('/netlify/functions/ai-advisory.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ situation })
        });

        const data = await response.json();
        
        if (response.ok) {
          displayAIResponse(data);
        } else {
          throw new Error(data.error || 'Failed to get AI advice');
        }
      } catch (error) {
        console.error('Error getting AI advice:', error);
        alert('Failed to get AI advice. Please try again.');
      } finally {
        // Reset button state
        analyzeText.classList.remove('hidden');
        analyzeSpinner.classList.add('hidden');
        analyzeBtn.disabled = false;
      }
    });

    function displayAIResponse(data) {
      const responseContainer = document.getElementById('aiResponse');
      const responseContent = document.getElementById('aiResponseContent');
      
      // Parse the AI response
      let responseData;
      try {
        responseData = JSON.parse(data);
      } catch (e) {
        // If not JSON, treat as plain text
        responseData = {
          explanation: data,
          nextSteps: 'Please review the advice above.',
          recommendedDocument: 'Appeal Letter',
          exampleText: 'Contact your insurance company for specific guidance.'
        };
      }

      responseContent.innerHTML = `
        <div class="response-section">
          <h4>📋 Next Steps</h4>
          <p>${responseData.nextSteps || 'Review the situation and take appropriate action.'}</p>
        </div>
        <div class="response-section">
          <h4>💡 Explanation</h4>
          <p>${responseData.explanation || 'No explanation provided.'}</p>
        </div>
        <div class="response-section">
          <h4>📄 Recommended Document</h4>
          <p>${responseData.recommendedDocument || 'Appeal Letter'}</p>
        </div>
        <div class="response-section">
          <h4>📝 Example Response</h4>
          <p>${responseData.exampleText || 'Contact your insurance company for specific guidance.'}</p>
        </div>
      `;
      
      responseContainer.classList.remove('hidden');
      responseContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Category tab functionality
    document.querySelectorAll('.category-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        // Remove active class from all tabs
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        e.target.classList.add('active');
        
        currentCategory = e.target.dataset.category;
        renderScenarios();
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filteredScenarios = allScenarios.map(category => ({
        ...category,
        situations: category.situations.filter(situation =>
          situation.title.toLowerCase().includes(searchTerm) ||
          situation.summary.toLowerCase().includes(searchTerm)
        )
      }));
      renderScenarios();
    });

    // Category filter functionality
    document.getElementById('categoryFilter').addEventListener('change', (e) => {
      const selectedCategory = e.target.value;
      if (selectedCategory === 'all') {
        filteredScenarios = allScenarios;
      } else {
        filteredScenarios = allScenarios.filter(cat => cat.category === selectedCategory);
      }
      renderScenarios();
    });

    // Initialize the page
    loadScenarios();
  </script>
</body>
</html>
