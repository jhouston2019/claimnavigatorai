<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Situational Advisory - ClaimNavigatorAI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="/app/assets/css/style.css">
  <style>
    :root{--navy:#0f172a;--primary:#1e40af;--primary-600:#1e3a8a;--accent:#3b82f6;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--panel:#f8fafc;--success:#10b981;--warn:#f59e0b;--error:#ef4444;}
    *{box-sizing:border-box}
    
    body.situational-advisory-page {
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:#ffffff !important;
      background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('/app/assets/images/backgrounds/paperwork6.jpeg') no-repeat center center fixed;
      background-size: cover;
      line-height:1.6;
    }
    
    /* Ensure all text is readable on dark background */
    body.situational-advisory-page, 
    body.situational-advisory-page * {
        color: #ffffff !important;
    }
    
    body.situational-advisory-page a {
        color: #dbeafe !important;
    }
    
    .header{
      position:sticky;
      top:0;
      z-index:1000;
      background:var(--navy);
      color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .header .container{
      max-width:1200px;
      margin:0 auto;
      padding:7px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      margin-right:auto;
    }
    .nav{
      display:flex;
      align-items:center;
      gap:0.5rem;
      margin-left:auto;
    }
    .nav a{
      color:#c9d4ff;
      text-decoration:none;
      padding:.5rem .75rem;
      border-radius:.5rem;
    }
    .nav a:hover{
      background:rgba(255,255,255,.1);
    }
    
    /* Hero Header */
    .hero-header {
      padding: 2rem 0;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 0.5rem 0;
    }
    
    .hero-subtitle {
      font-size: 1.2rem;
      color: #e2e8f0;
      margin: 0;
    }
    
    /* Card Styles - Consistent with other tools */
    .card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.25s ease;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      color: #fff;
    }
    
    .card:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-3px);
    }
    
    .card h3 {
      color: #1e3a8a !important;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      font-weight: bold !important;
    }
    
    .card p {
      color: #ffffff !important;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      line-height: 1.5;
    }
    
    /* AI Input Card */
    .ai-input-card {
      margin-bottom: 2rem;
    }
    
    .ai-input-card textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 1rem;
      resize: vertical;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-family: inherit;
    }
    
    .ai-input-card textarea::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .ai-input-card textarea:focus {
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
      outline: none;
    }
    
    .ai-analyze-btn {
      background: #1e3a8a;
      color: #ffffff;
      border: 2px solid #1e3a8a;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }
    
    .ai-analyze-btn:hover {
      background: #1e40af;
      border-color: #1e40af;
      transform: translateY(-1px);
    }
    
    .ai-analyze-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* AI Response Card */
    .ai-response-card {
      margin-bottom: 2rem;
    }
    
    .ai-response-card h3 {
      color: #ffffff !important;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .response-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .response-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .response-section h4 {
      color: #ffffff !important;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .response-section p {
      color: #e2e8f0 !important;
      margin: 0;
      line-height: 1.6;
    }
    
    /* Search and Filter Card */
    .search-filter-card {
      margin-bottom: 1.5rem;
    }
    
    .search-container {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .search-input,
    .category-select {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.95);
      color: #000000;
      font-family: inherit;
      font-size: 14px;
    }
    
    .category-select option {
      background: #ffffff;
      color: #000000;
    }
    
    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .search-input:focus,
    .category-select:focus {
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
      outline: none;
    }
    
    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .category-tab {
      padding: 10px 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .category-tab:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }
    
    .category-tab.active {
      background: #1e3a8a;
      border-color: #1e3a8a;
      color: #ffffff;
    }
    
    /* Scenarios Grid */
    .scenarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .scenario-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.25s ease;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      color: #fff;
    }
    
    .scenario-card:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-3px);
    }
    
    .scenario-header {
      margin-bottom: 1rem;
    }
    
    .scenario-title {
      color: #1e3a8a !important;
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0 0 0.5rem 0;
    }
    
    .scenario-summary {
      color: #ffffff !important;
      font-size: 0.9rem;
      margin: 0;
      line-height: 1.5;
    }
    
    .scenario-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: auto;
      flex-wrap: wrap;
    }
    
    .view-advice-btn,
    .generate-letter-btn {
      flex: 1;
      min-width: 120px;
      padding: 10px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .view-advice-btn:hover,
    .generate-letter-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }
    
    .generate-letter-btn {
      background: #1e3a8a;
      border-color: #1e3a8a;
    }
    
    .generate-letter-btn:hover {
      background: #1e40af;
      border-color: #1e40af;
    }
    
    .scenario-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .scenario-details.hidden {
      display: none;
    }
    
    .details-content h4 {
      color: #ffffff !important;
      font-size: 1rem;
      margin: 0.75rem 0 0.25rem 0;
      font-weight: 600;
    }
    
    .details-content h4:first-child {
      margin-top: 0;
    }
    
    .details-content p {
      color: #e2e8f0 !important;
      font-size: 0.9rem;
      margin: 0 0 0.75rem 0;
      line-height: 1.5;
    }
    
    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    main.container {
      padding: 2rem 1rem;
    }
    
    /* Hidden utility */
    .hidden {
      display: none !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .scenarios-grid {
        grid-template-columns: 1fr;
      }
      
      .hero-title {
        font-size: 2rem;
      }
      
      .hero-subtitle {
        font-size: 1rem;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .category-tabs {
        justify-content: center;
      }
    }
  </style>
</head>
<body class="situational-advisory-page font-inter">
  <header class="header">
    <div class="container">
      <div class="brand">Claim Navigation AI</div>
      <nav class="nav">
        <a href="/app/index.html">Home</a>
        <span>></span>
        <span>Situational Advisory</span>
        <span>></span>
        <a href="/app/resource-center.html">Resource Center</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Hero Header -->
    <div class="hero-header">
      <h1 class="hero-title">Situational Advisory</h1>
      <p class="hero-subtitle">Describe your claim situation and receive expert guidance tailored to your specific circumstances.</p>
    </div>

    <!-- AI Input Card -->
    <div class="card ai-input-card">
      <div class="ai-input-container">
        <textarea 
          id="situationInput" 
          placeholder="Describe your situation (e.g., 'My insurer said my roof leak isn't covered due to wear and tear')"
          rows="4"
        ></textarea>
        <button id="analyzeBtn" class="ai-analyze-btn">
          <span id="analyzeText">Analyze & Advise</span>
          <span id="analyzeSpinner" class="hidden">Analyzing...</span>
        </button>
      </div>
    </div>

    <!-- AI Response Display -->
    <div id="aiResponse" class="card ai-response-card hidden">
      <h3>AI Analysis & Recommendations</h3>
      <div id="aiResponseContent" class="ai-response-details"></div>
    </div>

    <!-- Search and Filter Card -->
    <div class="card search-filter-card">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search scenarios..." class="search-input" />
        <select id="categoryFilter" class="category-select">
          <option value="all">All Categories</option>
          <option value="Property">Property Claims</option>
          <option value="Commercial & Business Interruption">Commercial/Business</option>
          <option value="Catastrophe / Disaster">Catastrophe/Disaster</option>
        </select>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
      <button class="category-tab active" data-category="all">All Claims</button>
      <button class="category-tab" data-category="Property">Property Claims</button>
      <button class="category-tab" data-category="Commercial & Business Interruption">Commercial/Business</button>
      <button class="category-tab" data-category="Catastrophe / Disaster">Catastrophe/Disaster</button>
    </div>

    <!-- Scenarios Grid -->
    <div id="scenariosGrid" class="scenarios-grid">
      <!-- Scenarios will be loaded dynamically -->
    </div>
  </main>

  <script>
    let allScenarios = [];
    let filteredScenarios = [];
    let currentCategory = 'all';

    // Function to navigate to document generator page
    function openLetterModal(situation, documentType) {
      console.log('openLetterModal called with:', situation, documentType);
      // Map document types to document IDs
      const documentMapping = {
        'Appeal Letter': 'appeal-letter',
        'Demand Letter': 'demand-letter',
        'Notice of Delay Complaint': 'delay-complaint',
        'Coverage Clarification Request': 'coverage-clarification',
        'Proof of Loss': 'proof-of-loss',
        'Damage Assessment': 'damage-assessment',
        'Expert Opinion Request': 'expert-opinion-request',
        'Business Interruption Claim': 'business-interruption-claim',
        'Proof of Repairs Submission': 'proof-of-repairs',
        'Notice of Claim': 'notice-of-claim',
        'Settlement Offer': 'settlement-offer',
        'Regulatory Complaint': 'regulatory-complaint',
        'Appraisal Request': 'appraisal-request',
        'Evidence Log': 'evidence-log',
        'Expense Reimbursement': 'expense-reimbursement',
        'Photograph Log': 'photograph-log',
        'Out-of-Pocket Expenses': 'out-of-pocket-log',
        'ROM Estimate': 'rom-estimate',
        'Comparative Estimates': 'comparative-estimates',
        'Document Index': 'document-index'
      };

      // Get the document ID, fallback to appeal-letter if not found
      const documentId = documentMapping[documentType] || 'appeal-letter';

      // Navigate to letter generator with document type and situation
      console.log('Navigating to:', `/app/letter-generator.html?type=${encodeURIComponent(documentType)}&situation=${encodeURIComponent(situation)}`);
      window.location.href = `/app/letter-generator.html?type=${encodeURIComponent(documentType)}&situation=${encodeURIComponent(situation)}`;
    }

    // Load scenarios from JSON
    async function loadScenarios() {
      try {
        const response = await fetch('/assets/data/advisory.json');
        const data = await response.json();
        allScenarios = data;
        filteredScenarios = data;
        renderScenarios();
      } catch (error) {
        console.error('Error loading scenarios:', error);
        document.getElementById('scenariosGrid').innerHTML = '<p style="text-align: center; padding: 2rem; color: #ef4444;">Error loading scenarios. Please try again.</p>';
      }
    }

    function renderScenarios() {
      const container = document.getElementById('scenariosGrid');
      container.innerHTML = '';
      
      let scenariosToShow = [];
      
      if (currentCategory === 'all') {
        // Show all scenarios from all categories
        filteredScenarios.forEach(category => {
          scenariosToShow = scenariosToShow.concat(category.situations);
        });
      } else {
        // Filter by current category
        const categoryScenarios = filteredScenarios.filter(cat => cat.category === currentCategory);
        if (categoryScenarios.length > 0) {
          scenariosToShow = categoryScenarios[0].situations;
        }
      }
      
      if (scenariosToShow.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #ffffff;">No scenarios found for this category.</p>';
        return;
      }

      scenariosToShow.forEach((situation, index) => {
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.innerHTML = `
          <div class="scenario-header">
            <h3 class="scenario-title">${situation.title}</h3>
            <p class="scenario-summary">${situation.summary}</p>
          </div>
          <div class="scenario-actions">
            <button class="view-advice-btn" onclick="toggleAdvice(${index})">
              <span class="advice-text">View Advice</span>
              <span class="advice-icon">‚ñº</span>
            </button>
            <button class="generate-letter-btn" onclick="openLetterModal('${situation.title}', '${situation.document}')">
              Generate Letter
            </button>
          </div>
          <div class="scenario-details hidden" id="details-${index}">
            <div class="details-content">
              <h4>Recommended Action:</h4>
              <p>${situation.summary}</p>
              <h4>Document Type:</h4>
              <p>${situation.document}</p>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function toggleAdvice(index) {
      const details = document.getElementById(`details-${index}`);
      const button = details.previousElementSibling.querySelector('.view-advice-btn');
      const icon = button.querySelector('.advice-icon');
      
      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        icon.textContent = '‚ñ≤';
        button.querySelector('.advice-text').textContent = 'Hide Advice';
      } else {
        details.classList.add('hidden');
        icon.textContent = '‚ñº';
        button.querySelector('.advice-text').textContent = 'View Advice';
      }
    }


    // AI Analysis functionality
    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const situation = document.getElementById('situationInput').value.trim();
      if (!situation) {
        alert('Please describe your situation first.');
        return;
      }

      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeText = document.getElementById('analyzeText');
      const analyzeSpinner = document.getElementById('analyzeSpinner');
      
      // Show loading state
      analyzeText.classList.add('hidden');
      analyzeSpinner.classList.remove('hidden');
      analyzeBtn.disabled = true;

      try {
        const response = await fetch('/netlify/functions/ai-advisory.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ situation })
        });

        const data = await response.json();
        
        if (response.ok) {
          displayAIResponse(data);
        } else {
          throw new Error(data.error || 'Failed to get AI advice');
        }
      } catch (error) {
        console.error('Error getting AI advice:', error);
        alert('Failed to get AI advice. Please try again.');
      } finally {
        // Reset button state
        analyzeText.classList.remove('hidden');
        analyzeSpinner.classList.add('hidden');
        analyzeBtn.disabled = false;
      }
    });

    function displayAIResponse(data) {
      const responseContainer = document.getElementById('aiResponse');
      const responseContent = document.getElementById('aiResponseContent');
      
      // Parse the AI response
      let responseData;
      try {
        responseData = JSON.parse(data);
      } catch (e) {
        // If not JSON, treat as plain text
        responseData = {
          explanation: data,
          nextSteps: 'Please review the advice above.',
          recommendedDocument: 'Appeal Letter',
          exampleText: 'Contact your insurance company for specific guidance.'
        };
      }

      responseContent.innerHTML = `
        <div class="response-section">
          <h4>üìã Next Steps</h4>
          <p>${responseData.nextSteps || 'Review the situation and take appropriate action.'}</p>
        </div>
        <div class="response-section">
          <h4>üí° Explanation</h4>
          <p>${responseData.explanation || 'No explanation provided.'}</p>
        </div>
        <div class="response-section">
          <h4>üìÑ Recommended Document</h4>
          <p>${responseData.recommendedDocument || 'Appeal Letter'}</p>
        </div>
        <div class="response-section">
          <h4>üìù Example Response</h4>
          <p>${responseData.exampleText || 'Contact your insurance company for specific guidance.'}</p>
        </div>
      `;
      
      responseContainer.classList.remove('hidden');
      responseContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Category tab functionality
    document.querySelectorAll('.category-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        // Remove active class from all tabs
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        e.target.classList.add('active');
        
        currentCategory = e.target.dataset.category;
        renderScenarios();
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filteredScenarios = allScenarios.map(category => ({
        ...category,
        situations: category.situations.filter(situation =>
          situation.title.toLowerCase().includes(searchTerm) ||
          situation.summary.toLowerCase().includes(searchTerm)
        )
      }));
      renderScenarios();
    });

    // Category filter functionality
    document.getElementById('categoryFilter').addEventListener('change', (e) => {
      const selectedCategory = e.target.value;
      if (selectedCategory === 'all') {
        filteredScenarios = allScenarios;
      } else {
        filteredScenarios = allScenarios.filter(cat => cat.category === selectedCategory);
      }
      renderScenarios();
    });

    // Initialize the page
    loadScenarios();
  </script>
</body>
</html>
