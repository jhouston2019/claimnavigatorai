<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Organizer - ClaimNavigatorAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #1e40af;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
        }
        
        .upload-zone {
            transition: all 0.3s ease;
        }
        
        .upload-zone.dragover {
            background-color: #f0f9ff;
            border-color: #1e40af;
            transform: scale(1.02);
        }
        
        .file-card {
            transition: all 0.2s ease;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .category-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        
        .category-photos { @apply bg-blue-100 text-blue-800; }
        .category-documents { @apply bg-green-100 text-green-800; }
        .category-receipts { @apply bg-yellow-100 text-yellow-800; }
        .category-other { @apply bg-gray-100 text-gray-800; }
        
        .saved-indicator {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .saved-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-white">
    <!-- Header -->
    <header class="bg-[#0f172a] text-white p-4 flex justify-between items-center">
        <h1 class="text-lg font-semibold">üìÇ Evidence Organizer</h1>
        <a href="/app/resource-center/index.html" class="text-sm underline hover:text-blue-300 transition">‚Üê Resource Center</a>
    </header>

    <main class="p-6 space-y-8">
        <!-- Claim Information Section -->
        <section class="bg-gray-100 p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-[#0f172a]">Claim Information</h2>
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                    <input type="text" id="claimName" placeholder="Enter your name"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Policy #</label>
                    <input type="text" id="policyNumber" placeholder="Policy number"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Claim #</label>
                    <input type="text" id="claimNumber" placeholder="Claim number"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Loss</label>
                    <input type="date" id="dateOfLoss"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Insurance Company</label>
                    <input type="text" id="insuranceCompany" placeholder="Insurance company"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" id="phoneNumber" placeholder="Phone number"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="emailAddress" placeholder="Email address"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Address</label>
                    <input type="text" id="address" placeholder="Your address"
                        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" />
                </div>
            </div>
            <div class="mt-4 flex items-center">
                <span id="saveStatus" class="saved-indicator text-green-600 text-sm font-medium">‚úì Saved</span>
            </div>
        </section>

        <!-- Evidence Upload Section -->
        <section class="bg-gray-100 p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-[#0f172a]">Evidence Upload</h2>
            
            <!-- Upload Zone -->
            <div id="upload-zone" class="upload-zone border-2 border-dashed border-[#1e40af] rounded-2xl p-10 text-center text-gray-500 cursor-pointer hover:bg-[#f9fafb] transition">
                <div class="flex flex-col items-center">
                    <svg class="w-12 h-12 text-[#1e40af] mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">Drop files here or click to upload</p>
                    <p class="text-sm text-gray-400">Supports PDF, JPG, PNG, DOCX, XLSX, ZIP files</p>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx,.zip" class="hidden" />
            </div>

            <!-- File List -->
            <div id="file-list" class="grid md:grid-cols-3 gap-4 mt-6"></div>
        </section>

        <!-- AI Actions Section -->
        <section class="bg-gray-100 p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-[#0f172a]">AI Tools</h2>
            <div class="flex flex-wrap gap-4">
                <button id="categorizeBtn" class="bg-[#1e40af] text-white px-6 py-3 rounded-xl hover:bg-[#1d4ed8] transition font-medium">
                    ü§ñ Categorize with AI
                </button>
                <button id="checkEvidenceBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition font-medium">
                    ‚úÖ Check My Evidence
                </button>
                <button id="generateReportBtn" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    üìÑ Generate Summary Report (PDF)
                </button>
            </div>
            <div id="aiResults" class="mt-4 p-4 bg-white rounded-lg border hidden"></div>
        </section>

        <!-- Evidence Dashboard -->
        <section class="bg-gray-100 p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-[#0f172a]">Evidence Dashboard</h2>
            
            <!-- Summary Bar -->
            <div id="evidence-summary" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-[#1e40af]" id="totalFiles">0</div>
                    <div class="text-sm text-gray-600">Total Files</div>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalPhotos">0</div>
                    <div class="text-sm text-gray-600">Photos</div>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalDocs">0</div>
                    <div class="text-sm text-gray-600">Documents</div>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="totalReceipts">0</div>
                    <div class="text-sm text-gray-600">Receipts</div>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600" id="missingFiles">0</div>
                    <div class="text-sm text-gray-600">Missing</div>
                </div>
            </div>

            <!-- Category Grid -->
            <div id="category-grid" class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer" data-category="photos">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üì∏</span>
                        <h3 class="font-semibold">Photos</h3>
                    </div>
                    <div class="text-sm text-gray-600" id="photosCount">0 files</div>
                </div>
                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer" data-category="documents">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üìÑ</span>
                        <h3 class="font-semibold">Documents</h3>
                    </div>
                    <div class="text-sm text-gray-600" id="documentsCount">0 files</div>
                </div>
                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer" data-category="receipts">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üí∞</span>
                        <h3 class="font-semibold">Receipts</h3>
                    </div>
                    <div class="text-sm text-gray-600" id="receiptsCount">0 files</div>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="bg-white p-4 rounded-lg">
                <h3 class="font-semibold mb-4">Upload Timeline</h3>
                <canvas id="evidenceTimeline" class="w-full h-64"></canvas>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mt-6">
                <button id="downloadAllBtn" class="bg-[#1e40af] text-white px-6 py-3 rounded-xl hover:bg-[#1d4ed8] transition font-medium">
                    üì¶ Download All (ZIP)
                </button>
                <button id="shareLinkBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition font-medium">
                    üîó Generate Secure Share Link
                </button>
            </div>
        </section>
    </main>

    <!-- Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-semibold">Category Files</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="modalContent" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabase;
        let currentClaimId = null;
        let evidenceFiles = [];
        let timelineChart = null;

        // Initialize Supabase
        async function initSupabase() {
            if (window.__SUPABASE_URL && window.__SUPABASE_ANON_KEY) {
                supabase = window.supabase.createClient(window.__SUPABASE_URL, window.__SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
            } else {
                console.warn('Supabase not configured - using localStorage fallback');
                // Set fallback values for development
                window.__SUPABASE_URL = 'https://your-project.supabase.co';
                window.__SUPABASE_ANON_KEY = 'your-anon-key';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            await initSupabase();
            loadClaimData();
            setupEventListeners();
            loadEvidenceFiles();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Claim info auto-save
            const claimInputs = ['claimName', 'policyNumber', 'claimNumber', 'dateOfLoss', 'insuranceCompany', 'phoneNumber', 'emailAddress', 'address'];
            claimInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', debounce(saveClaimData, 1000));
            });

            // Upload zone
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // AI buttons
            document.getElementById('categorizeBtn').addEventListener('click', categorizeAllFiles);
            document.getElementById('checkEvidenceBtn').addEventListener('click', checkEvidenceCompleteness);
            document.getElementById('generateReportBtn').addEventListener('click', generateSummaryReport);

            // Dashboard buttons
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAllFiles);
            document.getElementById('shareLinkBtn').addEventListener('click', generateShareLink);

            // Category modals
            document.querySelectorAll('[data-category]').forEach(card => {
                card.addEventListener('click', () => openCategoryModal(card.dataset.category));
            });

            document.getElementById('closeModal').addEventListener('click', closeCategoryModal);
            document.getElementById('categoryModal').addEventListener('click', (e) => {
                if (e.target.id === 'categoryModal') closeCategoryModal();
            });
        }

        // Claim data management
        async function saveClaimData() {
            const claimData = {
                name: document.getElementById('claimName').value,
                policy_number: document.getElementById('policyNumber').value,
                claim_number: document.getElementById('claimNumber').value,
                date_of_loss: document.getElementById('dateOfLoss').value,
                insurance_company: document.getElementById('insuranceCompany').value,
                phone: document.getElementById('phoneNumber').value,
                email: document.getElementById('emailAddress').value,
                address: document.getElementById('address').value
            };

            // Save to localStorage
            localStorage.setItem('claimData', JSON.stringify(claimData));

            // Save to Supabase if available
            if (supabase) {
                try {
                    if (currentClaimId) {
                        const { error } = await supabase
                            .from('claim_metadata')
                            .update(claimData)
                            .eq('id', currentClaimId);
                        
                        if (error) throw error;
                        console.log('Claim data updated successfully');
                    } else {
                        const { data, error } = await supabase
                            .from('claim_metadata')
                            .insert(claimData)
                            .select();
                        
                        if (error) throw error;
                        if (data && data.length > 0) {
                            currentClaimId = data[0].id;
                            console.log('New claim created with ID:', currentClaimId);
                        }
                    }
                } catch (error) {
                    console.error('Error saving claim data to Supabase:', error);
                    // Still show save indicator for localStorage
                }
            }

            // Show save indicator
            showSaveIndicator();
        }

        function loadClaimData() {
            const savedData = localStorage.getItem('claimData');
            if (savedData) {
                const claimData = JSON.parse(savedData);
                Object.keys(claimData).forEach(key => {
                    const element = document.getElementById(key === 'policy_number' ? 'policyNumber' : 
                                                          key === 'claim_number' ? 'claimNumber' :
                                                          key === 'date_of_loss' ? 'dateOfLoss' :
                                                          key === 'insurance_company' ? 'insuranceCompany' :
                                                          key === 'phone' ? 'phoneNumber' :
                                                          key === 'email' ? 'emailAddress' : key);
                    if (element) element.value = claimData[key];
                });
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveStatus');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // File upload handling
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        async function processFiles(files) {
            for (const file of files) {
                await uploadFile(file);
            }
        }

        async function uploadFile(file) {
            const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Create file card
            const fileCard = createFileCard(file, fileId);
            document.getElementById('file-list').appendChild(fileCard);

            // Simulate upload progress
            const progressBar = fileCard.querySelector('.progress-bar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    progressBar.style.display = 'none';
                }
                progressBar.style.width = progress + '%';
            }, 200);

            // Auto-categorize with AI
            try {
                const aiResult = await categorizeWithAI(file);
                updateFileCard(fileCard, aiResult);
                
                // Save to evidence files
                const evidenceFile = {
                    id: fileId,
                    file_name: file.name,
                    file_url: URL.createObjectURL(file),
                    file_size: file.size,
                    file_type: file.type,
                    category: aiResult.category,
                    tags: aiResult.tags,
                    ai_summary: aiResult.summary,
                    notes: '',
                    created_at: new Date().toISOString()
                };
                
                evidenceFiles.push(evidenceFile);
                updateDashboard();
                saveEvidenceFilesToLocalStorage();
                
                // Save to Supabase if available
                if (supabase && currentClaimId) {
                    try {
                        const { data, error } = await supabase
                            .from('evidence_files')
                            .insert({
                                claim_id: currentClaimId,
                                file_name: file.name,
                                file_url: evidenceFile.file_url,
                                file_size: file.size,
                                file_type: file.type,
                                category: aiResult.category,
                                tags: aiResult.tags,
                                ai_summary: aiResult.summary
                            })
                            .select();
                        
                        if (error) throw error;
                        if (data && data.length > 0) {
                            evidenceFile.id = data[0].id; // Update with database ID
                            console.log('Evidence file saved to database:', data[0].id);
                        }
                    } catch (error) {
                        console.error('Error saving evidence file to Supabase:', error);
                    }
                }
            } catch (error) {
                console.error('Error categorizing file:', error);
                updateFileCard(fileCard, { category: 'other', tags: [], summary: 'Unable to categorize' });
            }
        }

        function createFileCard(file, fileId) {
            const card = document.createElement('div');
            card.className = 'file-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm';
            card.dataset.fileId = fileId;
            
            const isImage = file.type.startsWith('image/');
            const fileIcon = isImage ? 'üñºÔ∏è' : getFileIcon(file.type);
            
            card.innerHTML = `
                <div class="flex items-center mb-3">
                    <span class="text-2xl mr-3">${fileIcon}</span>
                    <div class="flex-1">
                        <h4 class="font-medium text-sm truncate">${file.name}</h4>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 delete-file" data-file-id="${fileId}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                <div class="progress-bar bg-blue-200 h-2 rounded mb-3" style="width: 0%"></div>
                <div class="category-badge category-other mb-2">Categorizing...</div>
                <textarea class="w-full text-xs border border-gray-300 rounded p-2 mb-2" placeholder="Add notes..." rows="2"></textarea>
                <div class="flex items-center justify-between">
                    <label class="flex items-center text-xs">
                        <input type="checkbox" class="mr-1 before-after-toggle">
                        Before/After
                    </label>
                    <div class="text-xs text-gray-500">${new Date().toLocaleDateString()}</div>
                </div>
            `;
            
            // Add event listeners
            card.querySelector('.delete-file').addEventListener('click', () => deleteFile(fileId));
            card.querySelector('.before-after-toggle').addEventListener('change', (e) => {
                card.classList.toggle('before-file', e.target.checked);
            });
            
            return card;
        }

        function updateFileCard(card, aiResult) {
            const badge = card.querySelector('.category-badge');
            badge.textContent = aiResult.category;
            badge.className = `category-badge category-${aiResult.category.toLowerCase()} mb-2`;
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('word') || type.includes('document')) return 'üìù';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'üìä';
            if (type.includes('zip') || type.includes('archive')) return 'üì¶';
            return 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function deleteFile(fileId) {
            const card = document.querySelector(`[data-file-id="${fileId}"]`);
            if (card) {
                card.remove();
                
                // Remove from Supabase if available
                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('evidence_files')
                            .delete()
                            .eq('id', fileId);
                        
                        if (error) throw error;
                        console.log('Evidence file deleted from database');
                    } catch (error) {
                        console.error('Error deleting evidence file from Supabase:', error);
                    }
                }
                
                evidenceFiles = evidenceFiles.filter(f => f.id !== fileId);
                updateDashboard();
                saveEvidenceFilesToLocalStorage();
            }
        }

        function saveEvidenceFilesToLocalStorage() {
            localStorage.setItem('evidenceFiles', JSON.stringify(evidenceFiles));
        }

        // AI Functions
        async function categorizeWithAI(file) {
            try {
                const response = await fetch('/netlify/functions/ai-categorize-evidence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size
                    })
                });
                
                if (!response.ok) throw new Error('AI categorization failed');
                return await response.json();
            } catch (error) {
                console.error('AI categorization error:', error);
                return { category: 'other', tags: [], summary: 'Unable to categorize', confidence: 0 };
            }
        }

        async function categorizeAllFiles() {
            const button = document.getElementById('categorizeBtn');
            button.disabled = true;
            button.textContent = 'ü§ñ Categorizing...';
            
            try {
                for (const file of evidenceFiles) {
                    const aiResult = await categorizeWithAI({ name: file.file_name, type: file.file_name.split('.').pop() });
                    file.category = aiResult.category;
                    file.tags = aiResult.tags;
                    file.ai_summary = aiResult.summary;
                }
                updateDashboard();
                showAIResults('All files have been re-categorized successfully!');
            } catch (error) {
                showAIResults('Error re-categorizing files: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'ü§ñ Categorize with AI';
            }
        }

        async function checkEvidenceCompleteness() {
            const button = document.getElementById('checkEvidenceBtn');
            button.disabled = true;
            button.textContent = '‚úÖ Checking...';
            
            try {
                const response = await fetch('/netlify/functions/ai-evidence-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        claimType: 'general',
                        uploadedCategories: evidenceFiles.map(f => f.category)
                    })
                });
                
                if (!response.ok) throw new Error('Evidence check failed');
                const result = await response.json();
                showAIResults(`Missing: ${result.missing.join(', ')}<br>Recommendations: ${result.recommendations.join(', ')}`);
            } catch (error) {
                showAIResults('Error checking evidence: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '‚úÖ Check My Evidence';
            }
        }

        async function generateSummaryReport() {
            const button = document.getElementById('generateReportBtn');
            button.disabled = true;
            button.textContent = 'üìÑ Generating...';
            
            try {
                const claimInfo = {
                    claimNumber: document.getElementById('claimNumber').value,
                    dateOfLoss: document.getElementById('dateOfLoss').value,
                    insuranceCompany: document.getElementById('insuranceCompany').value
                };
                
                const response = await fetch('/netlify/functions/generate-evidence-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        claimInfo,
                        evidenceList: evidenceFiles,
                        aiSummary: 'AI-generated summary of all evidence files'
                    })
                });
                
                if (!response.ok) throw new Error('Report generation failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evidence-report-${Date.now()}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAIResults('Summary report generated successfully!');
            } catch (error) {
                showAIResults('Error generating report: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'üìÑ Generate Summary Report (PDF)';
            }
        }

        function showAIResults(message, type = 'success') {
            const resultsDiv = document.getElementById('aiResults');
            resultsDiv.innerHTML = `<div class="p-4 rounded-lg ${type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">${message}</div>`;
            resultsDiv.classList.remove('hidden');
            setTimeout(() => resultsDiv.classList.add('hidden'), 5000);
        }

        // Dashboard functions
        function updateDashboard() {
            updateSummary();
            updateCategoryGrid();
            updateTimeline();
        }

        function updateSummary() {
            const total = evidenceFiles.length;
            const photos = evidenceFiles.filter(f => f.category === 'photos').length;
            const docs = evidenceFiles.filter(f => f.category === 'documents').length;
            const receipts = evidenceFiles.filter(f => f.category === 'receipts').length;
            const missing = Math.max(0, 10 - total); // Assuming 10 is a good target
            
            document.getElementById('totalFiles').textContent = total;
            document.getElementById('totalPhotos').textContent = photos;
            document.getElementById('totalDocs').textContent = docs;
            document.getElementById('totalReceipts').textContent = receipts;
            document.getElementById('missingFiles').textContent = missing;
        }

        function updateCategoryGrid() {
            const categories = ['photos', 'documents', 'receipts'];
            categories.forEach(category => {
                const count = evidenceFiles.filter(f => f.category === category).length;
                document.getElementById(`${category}Count`).textContent = `${count} files`;
            });
        }

        function updateTimeline() {
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            const ctx = document.getElementById('evidenceTimeline').getContext('2d');
            const dates = evidenceFiles.map(f => new Date(f.created_at).toLocaleDateString());
            const uniqueDates = [...new Set(dates)];
            const counts = uniqueDates.map(date => dates.filter(d => d === date).length);
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: uniqueDates,
                    datasets: [{
                        label: 'Files Uploaded',
                        data: counts,
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function openCategoryModal(category) {
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            title.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} Files`;
            
            const categoryFiles = evidenceFiles.filter(f => f.category === category);
            content.innerHTML = categoryFiles.map(file => `
                <div class="flex items-center p-3 border border-gray-200 rounded-lg">
                    <span class="text-2xl mr-3">${getFileIcon(file.file_name)}</span>
                    <div class="flex-1">
                        <h4 class="font-medium">${file.file_name}</h4>
                        <p class="text-sm text-gray-600">${file.ai_summary}</p>
                    </div>
                    <div class="text-sm text-gray-500">${new Date(file.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }

        async function downloadAllFiles() {
            // This would require a backend function to create a ZIP file
            showAIResults('Download all feature requires backend implementation', 'error');
        }

        async function generateShareLink() {
            // This would generate a secure share link
            showAIResults('Share link generation requires backend implementation', 'error');
        }

        async function loadEvidenceFiles() {
            if (supabase && currentClaimId) {
                try {
                    const { data, error } = await supabase
                        .from('evidence_files')
                        .select('*')
                        .eq('claim_id', currentClaimId)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        evidenceFiles = data;
                        updateDashboard();
                        console.log('Loaded', data.length, 'evidence files from database');
                    }
                } catch (error) {
                    console.error('Error loading evidence files:', error);
                }
            } else {
                // Load from localStorage as fallback
                const savedFiles = localStorage.getItem('evidenceFiles');
                if (savedFiles) {
                    evidenceFiles = JSON.parse(savedFiles);
                    updateDashboard();
                }
            }
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
