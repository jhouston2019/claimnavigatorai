<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Document Generator • Claim Navigator AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Generate professional claim documents with AI. Proof of Loss, Appeal, Demand, Inventory, Timeline, Appraisal, Delay, and more." />
  <style>
    :root{
      --navy:#1e3a8a;          /* primary */
      --navy-700:#1e40af;
      --blue:#3b82f6;          /* accent */
      --bg:#f9fafb;            /* app background */
      --panel:#ffffff;         /* cards/panels */
      --text:#111827;          /* body text */
      --muted:#6b7280;         /* secondary text */
      --border:#e5e7eb;        /* lines */
      --radius:14px;
      --shadow:0 6px 24px rgba(2,6,23,.06);
      --shadow-sm:0 2px 10px rgba(2,6,23,.05);
      --focus:0 0 0 3px rgba(59,130,246,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    }

    /* Shell */
    .wrap{display:grid; grid-template-columns: 300px 1fr; min-height:100vh}
    .sidebar{
      position:sticky; top:0; align-self:start; height:100vh; overflow:auto;
      background:linear-gradient(180deg, #0f172a 0%, var(--navy) 100%);
      color:#e5eaff; padding:18px 16px; border-right:1px solid rgba(255,255,255,.08);
    }
    .brand{
      display:flex; align-items:center; gap:10px; padding:10px 10px 14px 10px;
      border-radius:12px; color:#fff; font-weight:700; letter-spacing:.2px;
    }
    .brand svg{width:22px;height:22px;opacity:.9}
    .search{
      margin:10px; position:relative;
    }
    .search input{
      width:100%; border:none; outline:none; background:rgba(255,255,255,.08);
      color:#fff; padding:10px 12px 10px 36px; border-radius:10px;
    }
    .search svg{position:absolute; left:12px; top:10px; width:16px; height:16px; opacity:.55}
    .section-title{
      font-size:.78rem; text-transform:uppercase; letter-spacing:.12em;
      color:#c7cffc; margin:18px 10px 10px;
    }
    .nav-list{display:flex; flex-direction:column; gap:6px; padding:0 8px 6px 8px;}
    .nav-item{
      display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px 12px;
      border-radius:10px; color:#e8ecff; border:1px solid transparent;
      transition:.15s ease; text-decoration:none;
    }
    .nav-item:hover{background:rgba(255,255,255,.06)}
    .nav-item.active{
      background:linear-gradient(90deg, rgba(59,130,246,.18), rgba(30,64,175,.22));
      border-color:rgba(255,255,255,.14);
    }
    .nav-item svg{width:16px; height:16px; opacity:.9; flex:0 0 16px}

    /* Main */
    .main{padding:28px; display:flex; flex-direction:column; gap:18px}
    .header{
      position:sticky; top:0; z-index:20; background:linear-gradient(180deg, rgba(249,250,251,.9), rgba(249,250,251,.55) 70%, transparent);
      -webkit-backdrop-filter:saturate(120%) blur(6px); backdrop-filter:saturate(120%) blur(6px);
      padding:8px 0 12px 0; border-bottom:1px solid var(--border);
    }
    .title-row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{
      display:flex; align-items:center; gap:12px; font-size:1.15rem; font-weight:800; color:var(--navy);
    }
    .breadcrumbs{color:var(--muted); font-size:.9rem}
    .tip{color:var(--muted); font-size:.9rem}

    .workspace{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; align-items:start;
    }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px;
    }
    .doc-meta{color:var(--muted); font-size:.95rem; margin-top:6px}

    /* Form */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-full{grid-column:1 / -1}
    label{font-weight:600; font-size:.92rem; color:#0b1220}
    input[type="text"], input[type="date"], input[type="email"], textarea, select{
      width:100%; margin-top:6px; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      outline:none; background:#fff;
    }
    textarea{min-height:140px; resize:vertical}
    input:focus, textarea:focus, select:focus{box-shadow:var(--focus); border-color:var(--blue)}

    .btn-row{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
    .btn{
      appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:700;
      background:linear-gradient(90deg, var(--navy-700), var(--blue)); color:#fff; box-shadow:var(--shadow-sm);
    }
    .btn.secondary{background:#fff; color:var(--navy); border:1px solid var(--border)}
    .btn.ghost{background:transparent; color:var(--navy); border:1px dashed var(--border)}
    .btn:disabled{opacity:.65; cursor:not-allowed}

    /* Preview */
    .preview{
      min-height:220px; background:#fcfdff; border:1px dashed var(--border); border-radius:12px; padding:14px; overflow:auto;
      font-family:ui-serif, Georgia, "Times New Roman", Times, serif; line-height:1.5;
    }
    .preview.empty{display:flex; align-items:center; justify-content:center; color:var(--muted)}
    .preview h1,.preview h2,.preview h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:var(--border); margin:14px 0}

    /* Modal (Preview full) */
    .modal{position:fixed; inset:0; background:rgba(15,23,42,.66); display:none; align-items:center; justify-content:center; padding:20px; z-index:50}
    .modal.open{display:flex}
    .modal-panel{
      width:min(900px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:18px 18px 24px;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:12px; padding-bottom:8px; border-bottom:1px solid var(--border)}
    .modal-title{font-weight:800; color:var(--navy)}
    .close{background:transparent; border:none; font-size:22px; cursor:pointer}

    /* Print View */
    @media print{
      .sidebar, .header, .btn-row, .hr, .tip{display:none !important}
      .workspace{grid-template-columns:1fr !important}
      .card{box-shadow:none; border:none}
      body{background:#fff}
    }

    /* Mobile */
    @media (max-width: 1000px){
      .wrap{grid-template-columns: 1fr}
      .sidebar{position:static; height:auto; border-right:none; border-bottom:1px solid var(--border)}
      .workspace{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand" aria-label="Claim Navigator AI">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3z" stroke="white" stroke-width="1.5"/></svg>
        <div>Claim Navigator • <span style="opacity:.85">Generator</span></div>
      </div>

      <div class="search">
        <svg viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="white" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="search" placeholder="Search documents…" />
      </div>

      <div id="nav"></div>

      <div style="padding:12px 10px 4px; font-size:.85rem; color:#c6d0ff;">
        Tip: You can bookmark a specific document. The URL hash updates, e.g. <span style="opacity:.85">…/document-generator.html#appeal</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="header">
        <div class="title-row">
          <div class="title">
            <svg viewBox="0 0 24 24" fill="none" style="width:22px;height:22px"><path d="M5 4h14M5 8h14M5 12h14M5 16h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
            <span id="pageTitle">Document Generator</span>
          </div>
          <div class="breadcrumbs">← <a href="/index.html" style="color:var(--navy); text-decoration:none">Resource Center</a></div>
        </div>
        <div class="tip">Generate professional claim documents. Use AI to draft, then export as PDF or DOC.</div>
      </div>

      <div class="workspace">
        <!-- Form Panel -->
        <section class="card" id="formCard" aria-live="polite">
          <h2 id="docTitle" style="margin:0"></h2>
          <div id="docDesc" class="doc-meta"></div>
          <div class="hr"></div>

          <form id="docForm" class="grid" autocomplete="on"></form>

          <div class="btn-row">
            <button class="btn" id="btnDraft">Draft with AI</button>
            <button class="btn secondary" id="btnPreview" type="button">Preview</button>
            <button class="btn secondary" id="btnCopy" type="button">Copy Draft</button>
            <button class="btn secondary" id="btnExportPDF" type="button">Export PDF</button>
            <button class="btn secondary" id="btnExportDOC" type="button">Export DOC</button>
          </div>
        </section>

        <!-- Preview Panel -->
        <section class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <h3 style="margin:0">AI Draft</h3>
            <small class="muted">Edits are preserved until you leave.</small>
          </div>
          <div id="preview" class="preview empty">Your AI draft will appear here.</div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-panel">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Preview</div>
        <button class="close" id="modalClose" aria-label="Close">×</button>
      </div>
      <div id="modalBody" style="padding-top:12px"></div>
    </div>
  </div>

  <script>
    /***********************
     * Schema (inline fallback)
     * If you also have /assets/docs/schema.json in Supabase/Netlify, this script
     * will try to fetch it and merge/override these. This inline set guarantees
     * the page works standalone.
     ***********************/
    const INLINE_SCHEMAS = [
      /* --------- CORE --------- */
      {
        id:"proof-of-loss",
        group:"Core",
        title:"Proof of Loss",
        description:"Sworn statement of damages.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Email Address", name:"email", type:"email"},
          {label:"Phone Number", name:"phone", type:"text"},
          {label:"Your Address", name:"address", type:"text", class:"grid-full"},
          {label:"Details", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"appeal",
        group:"Core",
        title:"Appeal Letter",
        description:"Denied/underpaid? Appeal.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Email Address", name:"email", type:"email"},
          {label:"Phone Number", name:"phone", type:"text"},
          {label:"Your Address", name:"address", type:"text", class:"grid-full"},
          {label:"Denial/Underpayment Details", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"demand",
        group:"Core",
        title:"Demand Letter",
        description:"Formal payment request.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Amount Demanded (USD)", name:"amount", type:"text"},
          {label:"Email Address", name:"email", type:"email"},
          {label:"Phone Number", name:"phone", type:"text"},
          {label:"Your Address", name:"address", type:"text", class:"grid-full"},
          {label:"Basis for Demand / Evidence Summary", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"inventory",
        group:"Core",
        title:"Damage Inventory",
        description:"Line-item list.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Inventory Details (CSV or structured list)", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"diary",
        group:"Core",
        title:"Claim Timeline / Diary",
        description:"Chronological log.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Start Date", name:"start_date", type:"date"},
          {label:"End Date (optional)", name:"end_date", type:"date"},
          {label:"Events / Notes", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"repair-replace",
        group:"Core",
        title:"Repair vs Replace",
        description:"Cost worksheet.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Item/Area", name:"item", type:"text"},
          {label:"Repair Cost (USD)", name:"repair_cost", type:"text"},
          {label:"Replace Cost (USD)", name:"replace_cost", type:"text"},
          {label:"Notes / Rationale", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"out-of-pocket",
        group:"Core",
        title:"Out-of-Pocket Log",
        description:"ALE & expenses.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Expense Date", name:"expense_date", type:"date"},
          {label:"Category", name:"category", type:"text"},
          {label:"Amount (USD)", name:"amount", type:"text"},
          {label:"Description", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"appraisal",
        group:"Core",
        title:"Appraisal Demand",
        description:"Invoke appraisal clause.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Appraiser Proposed", name:"appraiser", type:"text"},
          {label:"Basis for Dispute", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"delay",
        group:"Core",
        title:"Notice of Delay",
        description:"Timelines exceeded.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Email Address", name:"email", type:"email"},
          {label:"Phone Number", name:"phone", type:"text"},
          {label:"Your Address", name:"address", type:"text", class:"grid-full"},
          {label:"Delay Details / Missed Deadlines", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"coverage-clarification",
        group:"Core",
        title:"Coverage Clarification",
        description:"Ask insurer to interpret.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim #", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Policy Section / Clause", name:"clause", type:"text"},
          {label:"Clarification Requested", name:"details", type:"textarea", class:"grid-full"}
        ]
      },

      /* --------- SUPPORT --------- */
      {
        id:"notice-of-claim",
        group:"Support",
        title:"Notice of Claim",
        description:"Initial loss report.",
        fields:[
          {label:"Your Name", name:"your_name", type:"text"},
          {label:"Policy #", name:"policy_number", type:"text"},
          {label:"Claim # (if assigned)", name:"claim_number", type:"text"},
          {label:"Date of Loss", name:"date_of_loss", type:"date"},
          {label:"Insurance Company", name:"insurer", type:"text"},
          {label:"Loss Description", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"rom-estimate",
        group:"Support",
        title:"ROM Estimate Report",
        description:"High-level cost range.",
        fields:[
          {label:"Scope / Area", name:"scope", type:"text"},
          {label:"Low Estimate (USD)", name:"low", type:"text"},
          {label:"High Estimate (USD)", name:"high", type:"text"},
          {label:"Notes", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"photo-log",
        group:"Support",
        title:"Photograph Log",
        description:"Captions & descriptions.",
        fields:[
          {label:"Shoot Date", name:"shoot_date", type:"date"},
          {label:"Location / Room", name:"location", type:"text"},
          {label:"Photo References (filenames/links)", name:"photos", type:"textarea", class:"grid-full"},
          {label:"Captions / Notes", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"document-index",
        group:"Support",
        title:"Document Index",
        description:"Auto-generated list.",
        fields:[
          {label:"Matter Name", name:"matter", type:"text"},
          {label:"Documents Included (list)", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"comparative-estimates",
        group:"Support",
        title:"Comparative Estimates",
        description:"Side-by-side.",
        fields:[
          {label:"Vendor A", name:"vendor_a", type:"text"},
          {label:"Amount A (USD)", name:"amount_a", type:"text"},
          {label:"Vendor B", name:"vendor_b", type:"text"},
          {label:"Amount B (USD)", name:"amount_b", type:"text"},
          {label:"Notes / Differences", name:"details", type:"textarea", class:"grid-full"}
        ]
      },
      {
        id:"settlement-sheet",
        group:"Support",
        title:"Settlement Sheet",
        description:"Offer vs value.",
        fields:[
          {label:"Carrier Offer (USD)", name:"offer", type:"text"},
          {label:"Your Valuation (USD)", name:"valuation", type:"text"},
          {label:"Delta (calc optional)", name:"delta", type:"text"},
          {label:"Notes", name:"details", type:"textarea", class:"grid-full"}
        ]
      }
    ];

    /* Globals */
    let SCHEMAS = [...INLINE_SCHEMAS];
    let currentId = null;
    const $ = sel => document.querySelector(sel);
    const navEl = $('#nav');
    const pageTitleEl = $('#pageTitle');
    const docTitleEl = $('#docTitle');
    const docDescEl = $('#docDesc');
    const formEl = $('#docForm');
    const previewEl = $('#preview');

    /* Try fetching external schema override (optional) */
    fetch('/assets/docs/schema.json', {cache:'no-store'}).then(r=>{
      if(!r.ok) throw new Error('no schema.json');
      return r.json();
    }).then(json=>{
      if(Array.isArray(json) && json.length){
        // merge by id (external wins)
        const map = new Map(INLINE_SCHEMAS.map(s=>[s.id,s]));
        json.forEach(s=>map.set(s.id, s));
        SCHEMAS = Array.from(map.values());
        buildNav(); // refresh if arrived late
      }
    }).catch(()=>{/* ignore, inline fallback is fine */});

    function iconFor(group){
      // Simple icon glyphs
      const core = '<svg viewBox="0 0 24 24" fill="none"><path d="M6 4h12v16H6zM9 8h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
      const sup  = '<svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
      return group === 'Core' ? core : sup;
    }

    function buildNav(filterText=''){
      const byGroup = {Core:[], Support:[]};
      SCHEMAS.forEach(s=>{
        if(filterText && !(`${s.title} ${s.description}`.toLowerCase().includes(filterText.toLowerCase()))) return;
        (byGroup[s.group] ||= []).push(s);
      });
      navEl.innerHTML = `
        <div class="section-title">Core Documents</div>
        <div class="nav-list" id="nav-core"></div>
        <div class="section-title">Support Documents</div>
        <div class="nav-list" id="nav-support"></div>
      `;
      ['Core','Support'].forEach(group=>{
        const list = document.getElementById('nav-'+group.toLowerCase());
        (byGroup[group]||[]).forEach(s=>{
          const a = document.createElement('a');
          a.className = 'nav-item';
          a.href = '#'+s.id;
          a.dataset.id = s.id;
          a.innerHTML = iconFor(group) + '<div><div style="font-weight:700">'+s.title+'</div><div style="opacity:.8; font-size:.85rem">'+s.description+'</div></div>';
          if(s.id === currentId) a.classList.add('active');
          list.appendChild(a);
        });
      });
    }

    function setActiveInNav(){
      navEl.querySelectorAll('.nav-item').forEach(el=>{
        el.classList.toggle('active', el.dataset.id === currentId);
      });
    }

    function getSchema(id){
      return SCHEMAS.find(s=>s.id===id) || SCHEMAS[0];
    }

    function fieldHtml(f){
      const baseCls = f.class ? (' '+f.class) : '';
      const name = f.name || f.label.toLowerCase().replace(/\s+/g,'_');
      const id = 'f_'+name;
      const common = `id="${id}" name="${name}"`;
      if(f.type === 'textarea'){
        return `<div class="grid-full${baseCls}">
          <label for="${id}">${f.label}</label>
          <textarea ${common} spellcheck="true" placeholder="Enter ${f.label.toLowerCase()}..."></textarea>
        </div>`;
      }
      if(f.type === 'select' && Array.isArray(f.options)){
        const opts = f.options.map(o=>`<option value="${o}">${o}</option>`).join('');
        return `<div${baseCls ? ' class="'+baseCls+'"' : ''}>
          <label for="${id}">${f.label}</label>
          <select ${common}>${opts}</select>
        </div>`;
      }
      const type = f.type || 'text';
      const ph = f.placeholder || '';
      return `<div${baseCls ? ' class="'+baseCls+'"' : ''}>
        <label for="${id}">${f.label}</label>
        <input type="${type}" ${common} placeholder="${ph}">
      </div>`;
    }

    function loadSaved(id){
      try{
        return JSON.parse(localStorage.getItem('docgen:'+id) || '{}');
      }catch{ return {}; }
    }
    function saveForm(id, data){
      localStorage.setItem('docgen:'+id, JSON.stringify(data));
    }
    function gatherFormData(){
      const data = {};
      formEl.querySelectorAll('input, textarea, select').forEach(el=>{
        data[el.name] = el.value;
      });
      return data;
    }
    function populateForm(data){
      formEl.querySelectorAll('input, textarea, select').forEach(el=>{
        if(data[el.name] != null) el.value = data[el.name];
      });
    }
    function setPreview(html){
      if(!html || !html.trim()){
        previewEl.classList.add('empty');
        previewEl.textContent = 'Your AI draft will appear here.';
      }else{
        previewEl.classList.remove('empty');
        previewEl.innerHTML = html;
      }
    }
    function textToHtmlLetter(title, data){
      // Simple default layout if AI not available: renders a formatted letter using the inputs
      const lines = [];
      const today = new Date().toLocaleDateString();
      lines.push(`<div style="text-align:right">${today}</div>`);
      if(data.your_name) lines.push(`<div><strong>${escapeHtml(data.your_name)}</strong></div>`);
      if(data.address) lines.push(`<div>${escapeHtml(data.address)}</div>`);
      lines.push(`<br/>`);
      if(data.insurer) lines.push(`<div>${escapeHtml(data.insurer)}</div>`);
      if(data.policy_number || data.claim_number){
        lines.push(`<div>Policy # ${escapeHtml(data.policy_number||'')} ${data.claim_number?' • Claim # '+escapeHtml(data.claim_number):''}</div>`);
      }
      lines.push(`<h2 style="margin:12px 0 6px 0">${escapeHtml(title)}</h2>`);
      if(data.details){
        lines.push(`<div style="white-space:pre-wrap">${escapeHtml(data.details)}</div>`);
      }else{
        lines.push(`<div class="muted">[Add details and click Draft with AI for a stronger version]</div>`);
      }
      return lines.join('\n');
    }
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function render(id){
      currentId = id || (location.hash ? location.hash.substring(1) : (SCHEMAS[0]?.id));
      const schema = getSchema(currentId);
      if(!schema) return;

      pageTitleEl.textContent = 'Document Generator';
      docTitleEl.textContent = schema.title;
      docDescEl.textContent = schema.description;

      formEl.innerHTML = (schema.fields || []).map(fieldHtml).join('');
      const saved = loadSaved(schema.id);
      populateForm(saved);

      // Form autosave
      formEl.oninput = () => {
        saveForm(schema.id, gatherFormData());
      };

      // If we already have a saved draft, show it
      const savedDraft = localStorage.getItem('docgen-draft:'+schema.id);
      setPreview(savedDraft ? savedDraft : '');

      buildNav($('#search').value || '');
      setActiveInNav();
      history.replaceState(null, '', '#'+schema.id);
    }

    /* Events */
    window.addEventListener('hashchange', () => render());
    $('#search').addEventListener('input', e => buildNav(e.target.value));

    // Buttons
    $('#btnDraft').addEventListener('click', async (e)=>{
      e.preventDefault();
      const schema = getSchema(currentId);
      const data = gatherFormData();
      saveForm(schema.id, data);

      // Call your Netlify function for AI generation
      const endpoint = '/netlify/functions/generate-document'; // adjust if your file is generate-document.js
      setPreview('<div class="muted">Drafting with AI…</div>');
      try{
        const res = await fetch(endpoint, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ documentId: schema.id, title: schema.title, fields: data })
        });
        if(!res.ok) throw new Error('AI function error');
        const out = await res.json();
        // Expect { html?: string, text?: string }
        let html = out.html;
        if(!html){
          // fallback from text
          const text = out.text || '';
          html = '<div style="white-space:pre-wrap">'+escapeHtml(text)+'</div>';
        }
        setPreview(html);
        localStorage.setItem('docgen-draft:'+schema.id, html);
      }catch(err){
        console.error(err);
        // Fallback: build a formatted letter locally
        const fallback = textToHtmlLetter(schema.title, data);
        setPreview(fallback + `<div class="hr"></div><div class="muted">AI service unavailable — rendered a formatted draft locally. You can edit details and retry AI.</div>`);
        localStorage.setItem('docgen-draft:'+schema.id, fallback);
      }
    });

    $('#btnPreview').addEventListener('click', ()=>{
      const modal = $('#modal');
      const schema = getSchema(currentId);
      $('#modalTitle').textContent = schema.title + ' — Preview';
      $('#modalBody').innerHTML = previewEl.classList.contains('empty') ? '<div class="muted">No draft yet.</div>' : previewEl.innerHTML;
      modal.classList.add('open');
    });
    $('#modalClose').addEventListener('click', ()=> $('#modal').classList.remove('open'));
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modal').classList.remove('open'); });

    $('#btnCopy').addEventListener('click', async ()=>{
      const html = previewEl.classList.contains('empty') ? '' : previewEl.innerText || previewEl.textContent;
      if(!html){ alert('No draft yet to copy.'); return; }
      await navigator.clipboard.writeText(html);
      toast('Draft copied to clipboard');
    });

    $('#btnExportPDF').addEventListener('click', ()=>{
      // Open a print-friendly window
      const schema = getSchema(currentId);
      const content = previewEl.classList.contains('empty') ? '<div>No draft yet.</div>' : previewEl.innerHTML;
      const win = window.open('', '_blank');
      win.document.write(`<!doctype html><html><head><title>${schema.title}</title>
        <meta charset="utf-8"><style>
          body{font-family:Georgia,serif; padding:40px; line-height:1.5}
          h1,h2,h3{margin:0 0 10px}
          .muted{color:#666}
        </style></head><body>${content}</body></html>`);
      win.document.close();
      win.focus();
      win.print(); // user can select "Save as PDF"
    });

    $('#btnExportDOC').addEventListener('click', ()=>{
      const schema = getSchema(currentId);
      const content = previewEl.classList.contains('empty') ? '<div>No draft yet.</div>' : previewEl.innerHTML;
      const html =
        `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${content}</body></html>`;
      const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${schema.title.replace(/\s+/g,'_')}.doc`;
      a.click();
      URL.revokeObjectURL(url);
    });

    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = `
        position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
        background:linear-gradient(90deg, var(--navy-700), var(--blue));
        color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); z-index:1000; font-weight:700;
      `;
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity='0'; }, 1400);
      setTimeout(()=> el.remove(), 1850);
    }

    // First load
    render();
  </script>
</body>
</html>