<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activation Checklist - Claim Navigator AI</title>
  <link rel="stylesheet" href="/app/assets/css/resource-center.css">
  <style>
    body {
      background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), 
                  url('/assets/images/backgrounds/Damage1.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      padding: 20px;
    }
    
    .activation-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .activation-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .activation-header h1 {
      color: #ffffff;
      font-size: 32px;
      margin: 0 0 8px 0;
    }
    
    .activation-header p {
      color: #9ca3af;
      font-size: 16px;
    }
    
    .activation-card {
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    
    .activation-card h2 {
      color: #ffffff;
      font-size: 20px;
      margin: 0 0 20px 0;
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      padding: 16px;
      margin-bottom: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s;
    }
    
    .checklist-item:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .checklist-item.completed {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.3);
    }
    
    .checklist-checkbox {
      width: 24px;
      height: 24px;
      margin-right: 16px;
      cursor: pointer;
      accent-color: #38bdf8;
    }
    
    .checklist-content {
      flex: 1;
    }
    
    .checklist-label {
      color: #ffffff;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .checklist-description {
      color: #9ca3af;
      font-size: 14px;
    }
    
    .checklist-action {
      margin-left: 16px;
    }
    
    .checklist-action a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }
    
    .checklist-action a:hover {
      text-decoration: underline;
    }
    
    .progress-summary {
      text-align: center;
      padding: 20px;
      background: rgba(56,189,248,0.1);
      border: 1px solid rgba(56,189,248,0.3);
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .progress-summary h3 {
      color: #38bdf8;
      margin: 0 0 12px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      overflow: hidden;
      margin: 12px 0;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: #38bdf8;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="activation-container">
    <div class="activation-header">
      <h1>Claim Activation Checklist</h1>
      <p>Complete these steps to fully activate your claim and unlock all features</p>
    </div>
    
    <div id="progress-summary" class="progress-summary">
      <h3>Activation Progress</h3>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <p id="progress-text" style="color: #9ca3af; margin: 0;">0% complete</p>
    </div>
    
    <div class="activation-card">
      <h2>Essential Steps</h2>
      <div id="checklist-items">
        <!-- Checklist items will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <script src="/app/assets/js/supabase-client.js"></script>
  <script src="/app/assets/js/auth-session.js"></script>
  <script src="/app/assets/js/claim-profile.js"></script>
  <script src="/app/assets/js/claim-health-v2.js"></script>
  <script src="/app/assets/js/toasts.js"></script>
  <script src="/app/assets/js/loading.js"></script>
  <script>
    (async () => {
      // Require authentication
      const isAuthenticated = await window.CNAuth?.requireAuth(true);
      if (!isAuthenticated) return;

      try {
        const user = await window.CNAuth.currentUser();
        if (!user) return;

        const supabase = await window.getSupabaseClient();
        const { data: claims } = await supabase
          .from('claims')
          .select('*')
          .eq('user_id', user.id)
          .eq('status', 'active')
          .limit(1);

        const activeClaim = claims && claims.length > 0 ? claims[0] : null;
        if (!activeClaim) {
          window.location.href = '/app/dashboard.html';
          return;
        }

        const profile = window.CNClaimProfile?.getClaimProfile() || {};
        const health = window.CNHealth ? window.CNHealth.compute() : { score: 0 };
        
        // Get evidence and document counts
        let photoCount = 0;
        let docCount = 0;
        if (window.CNStorage) {
          const evidenceData = window.CNStorage.getSection("evidence") || { count: 0 };
          const docData = window.CNStorage.getSection("documents") || { count: 0 };
          photoCount = evidenceData.count || 0;
          docCount = docData.count || 0;
        } else {
          photoCount = parseInt(localStorage.getItem("cn_evidence_photo_count") || "0", 10);
          docCount = parseInt(localStorage.getItem("cn_docs_generated") || "0", 10);
        }

        // Check roadmap stage 1 completion
        const roadmapState = JSON.parse(localStorage.getItem("claimRoadmapProgress") || "{}");
        const stage1Complete = roadmapState.completedStageIds?.includes(1) || false;

        // Check AI agent usage
        const activation = activeClaim.claim_data?.activation || {};
        const aiAgentUsed = activation.aiAgentUsed || false;

        // Define checklist items
        const checklistItems = [
          {
            id: 'lossDate',
            label: 'Add Loss Date',
            description: 'Set the date your loss occurred',
            action: '/app/onboarding/index.html',
            completed: !!profile.claim?.lossDate
          },
          {
            id: 'description',
            label: 'Add Claim Description',
            description: 'Describe what happened in detail',
            action: '/app/onboarding/index.html',
            completed: !!profile.damage?.description
          },
          {
            id: 'photos',
            label: 'Upload Photos',
            description: 'Upload at least 5 evidence photos',
            action: '/app/evidence-organizer.html',
            completed: photoCount >= 5
          },
          {
            id: 'firstDocument',
            label: 'Generate First Document',
            description: 'Create your first claim document',
            action: '/app/document-generator-v2/document-generator.html',
            completed: docCount >= 1
          },
          {
            id: 'aiAgent',
            label: 'Use AI Response Agent',
            description: 'Try the AI Response Agent once',
            action: '/app/resource-center/ai-response-agent.html',
            completed: aiAgentUsed
          },
          {
            id: 'stage1',
            label: 'Complete Roadmap Stage 1',
            description: 'Finish the first stage of your claim roadmap',
            action: '/app/resource-center/claim-roadmap.html',
            completed: stage1Complete
          },
          {
            id: 'health',
            label: 'Achieve Claim Health 60+',
            description: 'Improve your claim health score to 60 or higher',
            action: '/app/resource-center.html',
            completed: health.score >= 60
          }
        ];

        // Calculate progress
        const completed = checklistItems.filter(item => item.completed).length;
        const total = checklistItems.length;
        const progress = Math.round((completed / total) * 100);

        // Update progress display
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${progress}% complete (${completed}/${total} items)`;

        // Render checklist
        const checklistContainer = document.getElementById('checklist-items');
        checklistContainer.innerHTML = checklistItems.map(item => `
          <div class="checklist-item ${item.completed ? 'completed' : ''}">
            <input 
              type="checkbox" 
              class="checklist-checkbox" 
              ${item.completed ? 'checked' : ''} 
              disabled
            >
            <div class="checklist-content">
              <div class="checklist-label">${item.label}</div>
              <div class="checklist-description">${item.description}</div>
            </div>
            ${!item.completed ? `
              <div class="checklist-action">
                <a href="${item.action}">Complete â†’</a>
              </div>
            ` : ''}
          </div>
        `).join('');

        // Save activation state
        const newActivation = {
          lossDate: checklistItems[0].completed,
          description: checklistItems[1].completed,
          photosUploaded: checklistItems[2].completed,
          firstDocument: checklistItems[3].completed,
          aiAgentUsed: checklistItems[4].completed,
          stage1Complete: checklistItems[5].completed,
          health60Plus: checklistItems[6].completed
        };

        // Update claim data
        const updatedClaimData = {
          ...activeClaim.claim_data,
          activation: newActivation
        };

        await supabase
          .from('claims')
          .update({ 
            claim_data: updatedClaimData,
            updated_at: new Date().toISOString()
          })
          .eq('id', activeClaim.id);

      } catch (error) {
        console.error('CNError (Activation):', error);
        if (window.CNToast) {
          window.CNToast.error('Failed to load activation checklist');
        }
      }
    })();
  </script>
</body>
</html>

