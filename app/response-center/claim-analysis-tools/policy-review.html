<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Review & Coverage Analysis - ClaimNavigatorAI</title>
    <meta name="description" content="Analyze your insurance policy to identify coverage gaps and potential claim opportunities">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/app/assets/css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">‚Üê Back to Analysis Tools</a>
            <div class="nav-links">
                <a href="#help">Help</a>
            </div>
        </nav>
    </header>

    <main class="main-container">
        <div class="section">
            <h1>üìã Policy Review & Coverage Analysis</h1>
            <p>Analyze your insurance policy to identify coverage gaps and potential claim opportunities.</p>
            
            <form id="policy-review-form">
                <div class="form-group">
                    <label for="policy-text">Policy Text:</label>
                    <textarea 
                        id="policy-text" 
                        name="policy-text" 
                        placeholder="Paste your insurance policy text here..."
                        required
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="claim-type">Claim Type:</label>
                    <select id="claim-type" name="claim-type">
                        <option value="property">Property Damage</option>
                        <option value="business">Business Interruption</option>
                        <option value="liability">Liability</option>
                        <option value="auto">Auto</option>
                        <option value="health">Health</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="incident-description">Incident Description:</label>
                    <textarea 
                        id="incident-description" 
                        name="incident-description" 
                        placeholder="Describe the incident that led to your claim..."
                    ></textarea>
                </div>
                
                <button type="submit" class="btn" id="run-analysis">
                    Run Policy Analysis
                </button>
            </form>
        </div>

        <div id="analysis-results" class="section hidden">
            <h2>Analysis Results:</h2>
            <div id="results-content" class="form-group" style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 8px; white-space: pre-wrap; font-family: 'Courier New', monospace;"></div>
            <div class="text-center mt-4">
                <button class="btn" id="export-pdf">Export PDF</button>
                <button class="btn btn-secondary" id="save-draft">Save Draft</button>
            </div>
        </div>

        <div id="error-message" class="error-message hidden"></div>
        <div id="success-message" class="success-message hidden"></div>
    </main>

    <!-- Scripts -->
    <script type="module" type="module" src="/app/assets/js/api-client.js"></script>
    <script type="module" src="/app/assets/js/validation-utils.js"></script>
    <script type="module" src="/app/assets/js/error-handler.js"></script>
    <script type="module" type="module" src="/app/assets/js/ui-helpers.js"></script>
    <script type="module" type="module" src="/app/assets/js/diagnostics.js"></script>
    
    <script type="module">
        import { analyzePolicyText, createDoc, saveDraft } from '/assets/js/api-client.js';
        import { validateForm, showValidationError, clearValidationError } from '/assets/js/validation-utils.js';
        import { handleApiError } from '/assets/js/error-handler.js';
        import { setLoadingState, storeOriginalText } from '/assets/js/ui-helpers.js';
        import { initializeDiagnostics } from '/assets/js/diagnostics.js';

        // Initialize page
        initializeDiagnostics('policy-review', {
            requiredNodes: [
                'body',
                'main',
                '#policy-review-form',
                '#analysis-results'
            ],
            testEndpoints: ['policyAnalyzer']
        });

        // Get DOM elements
        const form = document.getElementById('policy-review-form');
        const runBtn = document.getElementById('run-analysis');
        const resultsSection = document.getElementById('analysis-results');
        const resultsContent = document.getElementById('results-content');
        const exportBtn = document.getElementById('export-pdf');
        const saveBtn = document.getElementById('save-draft');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Store original button text
        storeOriginalText('run-analysis');

        // Form handling
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Clear previous messages
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            resultsSection.classList.add('hidden');

            // Validate form
            const formData = {
                'policy-text': document.getElementById('policy-text').value,
                'claim-type': document.getElementById('claim-type').value,
                'incident-description': document.getElementById('incident-description').value
            };

            const validationRules = {
                'policy-text': { required: true, label: 'Policy text' }
            };

            const validation = validateForm(formData, validationRules);
            
            if (!validation.isValid) {
                Object.keys(validation.errors).forEach(field => {
                    showValidationError(field, validation.errors[field]);
                });
                return;
            }

            // Clear validation errors
            clearValidationError('policy-text');

            try {
                // Set loading state
                setLoadingState('run-analysis', true);

                // Prepare analysis data
                const analysisData = {
                    text: formData['policy-text'],
                    claimType: formData['claim-type'],
                    incidentDescription: formData['incident-description'],
                    timestamp: new Date().toISOString()
                };

                // Call policy analysis API
                const response = await analyzePolicyText(analysisData.text);
                
                // Display results
                resultsContent.textContent = response.analysis || response.result || response.message || 'Analysis completed successfully.';
                resultsSection.classList.remove('hidden');
                
                // Show success message
                successMessage.textContent = 'Policy analysis completed successfully!';
                successMessage.classList.remove('hidden');

            } catch (error) {
                console.error('Policy analysis error:', error);
                handleApiError(error, 'Policy Analysis');
                
                errorMessage.textContent = 'Failed to analyze policy. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                // Reset loading state
                setLoadingState('run-analysis', false);
            }
        });

        // Export PDF
        exportBtn.addEventListener('click', async () => {
            try {
                setLoadingState('export-pdf', true);
                
                const content = resultsContent.textContent;
                const response = await createDoc({
                    content,
                    format: 'pdf',
                    type: 'policy-analysis',
                    title: 'Policy Analysis Report'
                });
                
                if (response.downloadUrl) {
                    window.open(response.downloadUrl, '_blank');
                    successMessage.textContent = 'PDF exported successfully!';
                    successMessage.classList.remove('hidden');
                }
            } catch (error) {
                handleApiError(error, 'PDF Export');
            } finally {
                setLoadingState('export-pdf', false);
            }
        });

        // Save draft
        saveBtn.addEventListener('click', async () => {
            try {
                setLoadingState('save-draft', true);
                
                const draftData = {
                    type: 'policy-analysis',
                    content: resultsContent.textContent,
                    timestamp: new Date().toISOString()
                };
                
                await saveDraft(draftData);
                
                successMessage.textContent = 'Draft saved successfully!';
                successMessage.classList.remove('hidden');
            } catch (error) {
                handleApiError(error, 'Save Draft');
            } finally {
                setLoadingState('save-draft', false);
            }
        });
    </script>
<script type="module" src="/app/assets/js/window-bridge.js"></script>
<script type="module" src="/app/assets/js/i18n.js"></script>
</body>
</html>
