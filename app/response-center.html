<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response Center - ClaimNavigatorAI</title>
  <meta name="description" content="AI-powered claim response center with document library, AI response generation, claim analysis tools, and playbook.">
  <style>
    :root {
      --primary: #1e40af;
      --accent: #3b82f6;
      --border: #e5e7eb;
      --text-secondary: #6b7280;
      --bg-light: #f9fafb;
    }
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fff; }
    header { background:#0f172a; padding:1rem; color:#fff; position:sticky; top:0; }
    nav { display:flex; justify-content:space-between; align-items:center; }
    .nav-links { display:flex; gap:1rem; }
    .nav-links a { color:#fff; text-decoration:none; }
    .main-content { padding:2rem; }
    .tabs { display:flex; border-bottom:2px solid var(--border); margin-bottom:1.5rem; flex-wrap:wrap; }
    .tab { padding:1rem; cursor:pointer; }
    .tab.active { border-bottom:3px solid var(--primary); font-weight:bold; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .btn-primary { background:var(--primary); color:#fff; border:none; border-radius:0.5rem; padding:0.5rem 1rem; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn-secondary { background:var(--accent); color:#fff; border:none; border-radius:0.5rem; padding:0.5rem 1rem; cursor:pointer; text-decoration:none; display:inline-block; }
    .tool-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:1rem; }
    .tool-card { background:var(--bg-light); padding:1rem; border:1px solid var(--border); border-radius:0.5rem; }
    .tool-title { font-weight:bold; margin-bottom:0.5rem; }
    .tool-desc { font-size:0.9rem; color:var(--text-secondary); margin-bottom:0.5rem; }
    .tool-output { display:none; background:#fff; border:1px solid var(--border); border-radius:0.5rem; padding:0.75rem; white-space:pre-wrap; margin-top:0.5rem; min-height:80px; }
    .action-buttons { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid var(--primary); border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0% { transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    /* Accordion for Claim Playbook */
    .accordion .accordion-item { border:1px solid var(--border); border-radius:0.5rem; margin-bottom:1rem; overflow:hidden; }
    .accordion-header { width:100%; text-align:left; background:var(--bg-light); padding:0.75rem; border:none; font-weight:bold; cursor:pointer; }
    .accordion-body { display:none; padding:1rem; background:#fff; border-top:1px solid var(--border); }
    .accordion-item.active .accordion-body { display:block; }
    .accordion-body ul { list-style:none; padding:0; }
    .accordion-body li { margin-bottom:0.5rem; }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">ClaimNavigatorAI</div>
      <div class="nav-links">
        <a href="../index.html">Home</a>
        <a href="../product.html">Product</a>
        <a href="response-center.html">Response Center</a>
        <a href="settings.html">Settings</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </nav>
  </header>

  <main class="main-content">
    <h1>Response Center</h1>
    <p>AI-powered tools to strengthen your claim and generate professional responses</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event,'ai-agent')">AI Response & Analysis Agent</button>
      <button class="tab" onclick="switchTab(event,'my-documents')">My Documents</button>
      <button class="tab" onclick="switchTab(event,'analysis-tools')">Claim Analysis Tools</button>
      <button class="tab" onclick="switchTab(event,'claim-playbook')">Claim Playbook</button>
      <button class="tab" onclick="switchTab(event,'settings')">Settings</button>
    </div>

    <!-- AI Agent -->
    <div id="ai-agent" class="tab-content active">
      <textarea id="input-text" style="width:100%; min-height:120px; margin-bottom:1rem;" placeholder="Paste insurer correspondence..."></textarea>
      <div class="action-buttons">
        <button class="btn-primary" onclick="generateResponse()">Generate Response</button>
        <button class="btn-primary" onclick="exportDoc('docx')">Export DOCX</button>
        <button class="btn-primary" onclick="exportDoc('pdf')">Export PDF</button>
        <button class="btn-primary" onclick="saveDraft()">Save to My Documents</button>
        <select id="language-select" style="padding:0.5rem; border-radius:0.5rem;">
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div id="ai-output" class="tool-output"></div>
      <div id="confidence-meter" style="margin-top:0.5rem; font-size:0.9rem; color:var(--text-secondary);"></div>
      <h3>Session History</h3>
      <div id="session-history"></div>
    </div>

    <!-- My Documents -->
    <div id="my-documents" class="tab-content">
      <h2>My Documents</h2>
      <div class="lang-toggle" style="margin-bottom:1rem;">
        <button onclick="setLang('en')" class="btn-primary">English</button>
        <button onclick="setLang('es')" class="btn-secondary">Español</button>
      </div>
      <input type="text" id="doc-search" placeholder="Search documents..."
        oninput="filterDocuments()" style="width:100%; margin-bottom:1rem; padding:0.5rem;">
      <input type="file" id="doc-upload" onchange="uploadDocument()" style="margin-bottom:1rem;">
      <div id="documents-container"></div>
    </div>

    <!-- Claim Analysis Tools -->
    <div id="analysis-tools" class="tab-content">
      <h2>Claim Analysis Tools</h2>
      <div class="tool-grid" id="tool-grid"></div>
    </div>

    <!-- Claim Playbook -->
    <div id="claim-playbook" class="tab-content">
      <h2>Claim Playbook</h2>
      <p>Step-by-step roadmap for managing your insurance claim. Expand each phase for checklists, decision points, and the right documents.</p>

      <div class="accordion">

        <div class="accordion-item">
          <button class="accordion-header">Phase 1: Initial Notice of Loss</button>
          <div class="accordion-body">
            <ul>
              <li>Notify insurer immediately after the loss</li>
              <li>Submit initial claim form</li>
              <li>Document date/time of event and initial damages</li>
              <li>Upload proof of loss (photos, receipts)</li>
              <li>Track claim number & adjuster contact</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 2: Documentation & Evidence</button>
          <div class="accordion-body">
            <ul>
              <li>Collect receipts, invoices, estimates</li>
              <li>Upload contractor reports</li>
              <li>Maintain expense log for ALE (Additional Living Expenses)</li>
              <li>Cross-reference with policy limits</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 3: Adjuster Inspection</button>
          <div class="accordion-body">
            <ul>
              <li>Schedule inspection with insurer’s adjuster</li>
              <li>Prepare property for walkthrough</li>
              <li>Provide all requested documentation</li>
              <li>Request a copy of the adjuster’s report</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 4: Estimate Review</button>
          <div class="accordion-body">
            <ul>
              <li>Review insurer’s estimate line-by-line</li>
              <li>Compare with contractor estimates</li>
              <li>Highlight discrepancies for negotiation</li>
              <li>Prepare supplemental documentation</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 5: Negotiation</button>
          <div class="accordion-body">
            <ul>
              <li>Communicate discrepancies to adjuster</li>
              <li>Submit revised estimates</li>
              <li>Keep written record of all communications</li>
              <li>Escalate if adjuster refuses fair settlement</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 6: Supplemental Claims</button>
          <div class="accordion-body">
            <ul>
              <li>File additional claims for missed damages</li>
              <li>Submit contractor invoices for hidden damages</li>
              <li>Document ongoing ALE expenses</li>
              <li>Track all supplemental claim approvals</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 7: Escalation</button>
          <div class="accordion-body">
            <ul>
              <li>Send formal demand letter</li>
              <li>Request supervisor review</li>
              <li>Engage public adjuster or legal counsel</li>
              <li>Prepare for appraisal or mediation</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 8: Appraisal / Mediation</button>
          <div class="accordion-body">
            <ul>
              <li>Initiate appraisal clause if available</li>
              <li>Hire independent appraiser</li>
              <li>Engage mediation/arbitration if required</li>
              <li>Maintain documentation trail for litigation</li>
            </ul>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header">Phase 9: Final Settlement & Payment</button>
          <div class="accordion-body">
            <ul>
              <li>Review final settlement offer</li>
              <li>Ensure payment matches settlement</li>
              <li>Confirm ALE reimbursement</li>
              <li>Close out claim and archive documents</li>
            </ul>
          </div>
        </div>

      </div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab-content">
      <h2>Account Settings</h2>
      <h3>Credit Usage Log</h3>
      <table id="credit-log-table" border="1" cellspacing="0" cellpadding="6" style="width:100%; margin-bottom:1rem; border-collapse:collapse; font-size:0.9rem;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>Date</th>
            <th>Tool</th>
            <th>Language</th>
            <th>Tokens Used</th>
          </tr>
        </thead>
        <tbody id="credit-log-body">
          <tr><td colspan="4">Loading...</td></tr>
        </tbody>
      </table>
      <button class="btn-secondary" onclick="downloadAllOutputs()">Download All Outputs (ZIP)</button>
    </div>
  </main>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // Initialize Supabase client
  const supabase = createClient(
    "https://bnxvfxtpsxgfpltflyrr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJueHZmeHRwc3hnZnBsdGZseXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjUyMDUsImV4cCI6MjA3MTkwMTIwNX0.6oW8eiy5Q6ruYLfitxYkUp5MmjmdycvVod--5hiFOks"
  );

  // --- Tabs ---
  function switchTab(event, tab) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    event.target.classList.add('active');
  }

  async function logout() {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  }

  function getLanguage() {
    return document.getElementById('language-select')?.value || 'en';
  }

  function addToHistory(tool, text) {
    const h = document.getElementById('session-history');
    const div = document.createElement('div');
    div.textContent = `[${tool}] ${text.substring(0, 100)}...`;
    h.appendChild(div);
  }

  // Helper: get auth header
  async function getAuthHeader() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("Not logged in");
    return { Authorization: `Bearer ${session.access_token}`, 'Content-Type': 'application/json' };
  }

  // --- AI Agent ---
  async function generateResponse() {
    const input = document.getElementById('input-text').value.trim();
    if (!input) return alert("Please paste text first.");
    const out = document.getElementById('ai-output');
    out.style.display = 'block';
    out.innerHTML = `<div class="spinner"></div> Generating...`;

    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/generate-response', {
        method: 'POST',
        headers,
        body: JSON.stringify({ inputText: input, language: getLanguage() })
      });
      const data = await res.json();
      if (res.ok && data.draft) {
        out.textContent = data.draft;
        document.getElementById('confidence-meter').innerText = "Confidence: High";
        addToHistory("ai-agent", data.draft);
      } else {
        out.textContent = data.error || "Failed.";
      }
    } catch (e) {
      console.error(e);
      out.textContent = "Error generating.";
    }
  }

  async function saveDraft() {
    const text = document.getElementById('ai-output').innerText;
    if (!text) return alert("No draft.");
    try {
      const headers = await getAuthHeader();
      await fetch('/.netlify/functions/save-draft', {
        method: 'POST',
        headers,
        body: JSON.stringify({ content: text })
      });
      alert("Draft saved.");
    } catch (err) {
      console.error("Save failed:", err);
    }
  }

  async function exportDoc(type) {
    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/export-doc', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          type,
          content: document.getElementById('ai-output').innerText
        })
      });
      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `AI-Response.${type}`;
      link.click();
    } catch (err) {
      console.error("Export failed:", err);
    }
  }

  // --- My Documents ---
  async function loadDocuments() {
    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/list-documents', {
        method: 'POST',
        headers,
        body: JSON.stringify({ lang: localStorage.getItem('lang') || 'en' })
      });
      const docs = await res.json();
      const container = document.getElementById("documents-container");
      container.innerHTML = "";

      if (res.ok && Array.isArray(docs) && docs.length > 0) {
        docs.forEach(doc => {
          const card = document.createElement("div");
          card.className = "tool-card";
          card.innerHTML = `
            <div class="tool-title">${doc.label}</div>
            <div class="tool-desc">${doc.description || "Insurance Document"}</div>
            <div class="action-buttons">
              <button class="btn-primary" onclick="openDocument('${doc.templatePath}')">Template</button>
              <button class="btn-secondary" onclick="openDocument('${doc.samplePath}')">Sample</button>
            </div>
          `;
          container.appendChild(card);
        });
      } else {
        container.innerHTML = `<p>No documents found.</p>`;
      }
    } catch (err) {
      console.error("Error loading documents:", err);
      document.getElementById("documents-container").innerHTML =
        `<p style="color:red;">Failed to load documents.</p>`;
    }
  }

  async function openDocument(filePath) {
    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/generate-signed-url', {
        method: "POST",
        headers,
        body: JSON.stringify({ fileName: filePath })
      });
      const data = await res.json();
      if (res.ok && data.url) {
        window.open(data.url, "_blank");
      } else {
        alert("Failed to load document");
      }
    } catch (err) {
      console.error("Signed URL error:", err);
      alert("Error opening document");
    }
  }

  async function uploadDocument() {
    const file = document.getElementById('doc-upload').files[0];
    if (!file) return;
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not logged in");

      const formData = new FormData();
      formData.append("file", file);

      await fetch('/.netlify/functions/classify-upload', {
        method: 'POST',
        headers: { Authorization: `Bearer ${session.access_token}` },
        body: formData
      });
      alert("Document uploaded & classified");
      loadDocuments();
    } catch (err) {
      console.error("Upload failed:", err);
    }
  }

  function setLang(newLang) {
    localStorage.setItem("lang", newLang);
    loadDocuments();
  }

  function filterDocuments() {
    const searchTerm = document.getElementById('doc-search').value.toLowerCase();
    const cards = document.querySelectorAll('.tool-card');
    
    cards.forEach(card => {
      const title = card.querySelector('.tool-title').textContent.toLowerCase();
      const desc = card.querySelector('.tool-desc').textContent.toLowerCase();
      
      if (title.includes(searchTerm) || desc.includes(searchTerm)) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // --- Credit Log ---
  async function loadCreditLog() {
    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/get-credit-log', {
        method: 'POST',
        headers,
        body: JSON.stringify({})
      });
      const data = await res.json();
      const tbody = document.getElementById('credit-log-body');
      tbody.innerHTML = "";

      if (res.ok && data.success && data.logs.length > 0) {
        data.logs.forEach(log => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.mode}</td>
            <td>${log.language}</td>
            <td>${log.tokens_used ?? "-"}</td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="4">No logs found.</td></tr>`;
      }
    } catch (err) {
      console.error("Error loading credit log:", err);
      document.getElementById('credit-log-body').innerHTML =
        `<tr><td colspan="4">Error loading log.</td></tr>`;
    }
  }

  // --- Download All Outputs ---
  async function downloadAllOutputs() {
    try {
      const headers = await getAuthHeader();
      const res = await fetch('/.netlify/functions/download-all', {
        method: 'POST',
        headers,
        body: JSON.stringify({})
      });

      if (!res.ok) {
        const errMsg = await res.text();
        throw new Error(errMsg || "Download failed");
      }

      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'outputs.zip';
      link.click();
    } catch (err) {
      console.error("Download failed:", err);
      alert("Error downloading outputs.");
    }
  }

  // --- Auth Guard + Init ---
  document.addEventListener('DOMContentLoaded', async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("You must log in first.");
      window.location.href = "login.html";
      return;
    }

    loadDocuments();
    loadCreditLog();
    document.querySelectorAll('.accordion-header').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.parentElement.classList.toggle('active');
      });
    });
  });
</script>
</body>
</html>
