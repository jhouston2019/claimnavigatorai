<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response Center - ClaimNavigatorAI</title>
  <meta name="description" content="AI-powered claim response center with document library, AI response generation, claim analysis tools, and playbook.">
  <style>
    :root {
      --primary: #1e40af;
      --accent: #3b82f6;
      --border: #e5e7eb;
      --text-secondary: #6b7280;
      --bg-light: #f9fafb;
    }
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fff; }
    header { background:#0f172a; padding:1rem; color:#fff; position:sticky; top:0; }
    nav { display:flex; justify-content:space-between; align-items:center; }
    .nav-links { display:flex; gap:1rem; }
    .nav-links a { color:#fff; text-decoration:none; }
    .main-content { padding:2rem; }
    .tabs { display:flex; border-bottom:2px solid var(--border); margin-bottom:1.5rem; flex-wrap:wrap; }
    .tab { padding:1rem; cursor:pointer; }
    .tab.active { border-bottom:3px solid var(--primary); font-weight:bold; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .btn-primary { background:var(--primary); color:#fff; border:none; border-radius:0.5rem; padding:0.5rem 1rem; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn-secondary { background:var(--accent); color:#fff; border:none; border-radius:0.5rem; padding:0.5rem 1rem; cursor:pointer; text-decoration:none; display:inline-block; }
    .tool-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:1rem; }
    .tool-card { background:var(--bg-light); padding:1rem; border:1px solid var(--border); border-radius:0.5rem; }
    .tool-title { font-weight:bold; margin-bottom:0.5rem; }
    .tool-desc { font-size:0.9rem; color:var(--text-secondary); margin-bottom:0.5rem; }
    .tool-output { display:none; background:#fff; border:1px solid var(--border); border-radius:0.5rem; padding:0.75rem; white-space:pre-wrap; margin-top:0.5rem; min-height:80px; }
    .action-buttons { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid var(--primary); border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0% { transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    /* Accordion for Claim Playbook */
    .accordion .accordion-item { border:1px solid var(--border); border-radius:0.5rem; margin-bottom:1rem; overflow:hidden; }
    .accordion-header { width:100%; text-align:left; background:var(--bg-light); padding:0.75rem; border:none; font-weight:bold; cursor:pointer; }
    .accordion-body { display:none; padding:1rem; background:#fff; border-top:1px solid var(--border); }
    .accordion-item.active .accordion-body { display:block; }
    .accordion-body ul { list-style:none; padding:0; }
    .accordion-body li { margin-bottom:0.5rem; }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">ClaimNavigatorAI</div>
      <div class="nav-links">
        <a href="../index.html">Home</a>
        <a href="../product.html">Product</a>
        <a href="response-center.html">Response Center</a>
        <a href="settings.html">Settings</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </nav>
  </header>

  <main class="main-content">
    <h1>Response Center</h1>
    <p>AI-powered tools to strengthen your claim and generate professional responses</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('ai-agent')">AI Response & Analysis Agent</button>
      <button class="tab" onclick="switchTab('my-documents')">My Documents</button>
      <button class="tab" onclick="switchTab('analysis-tools')">Claim Analysis Tools</button>
      <button class="tab" onclick="switchTab('claim-playbook')">Claim Playbook</button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- AI Agent -->
    <div id="ai-agent" class="tab-content active">
      <textarea id="input-text" style="width:100%; min-height:120px; margin-bottom:1rem;" placeholder="Paste insurer correspondence..."></textarea>
      <div class="action-buttons">
        <button class="btn-primary" onclick="generateResponse()">Generate Response</button>
        <button class="btn-primary" onclick="exportDoc('docx')">Export DOCX</button>
        <button class="btn-primary" onclick="exportDoc('pdf')">Export PDF</button>
        <button class="btn-primary" onclick="saveDraft()">Save to My Documents</button>
        <select id="language-select" style="padding:0.5rem; border-radius:0.5rem;">
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div id="ai-output" class="tool-output"></div>
      <div id="confidence-meter" style="margin-top:0.5rem; font-size:0.9rem; color:var(--text-secondary);"></div>
      <h3>Session History</h3>
      <div id="session-history"></div>
    </div>

    <!-- My Documents -->
    <div id="my-documents" class="tab-content">
      <h2>My Documents</h2>
      <div class="lang-toggle" style="margin-bottom:1rem;">
        <button onclick="setLang('en')" class="btn-primary">English</button>
        <button onclick="setLang('es')" class="btn-secondary">Español</button>
      </div>
      <input type="text" id="doc-search" placeholder="Search documents..." 
             oninput="filterDocuments()" style="width:100%; margin-bottom:1rem; padding:0.5rem;">
      <input type="file" id="doc-upload" onchange="uploadDocument()" style="margin-bottom:1rem;">
      <div id="documents-container"></div>
    </div>

    <!-- Claim Analysis Tools -->
    <div id="analysis-tools" class="tab-content">
      <h2>Claim Analysis Tools</h2>
      <div class="tool-grid" id="tool-grid"></div>
    </div>

    <!-- Claim Playbook -->
    <!-- (all your Phases 1–9 and progress tracker remain unchanged, as in your file) -->

    <!-- Settings -->
    <div id="settings" class="tab-content">
      <h2>Account Settings</h2>
      <h3>Credit Usage Log</h3>
      <table id="credit-log-table" border="1" cellspacing="0" cellpadding="6" style="width:100%; margin-bottom:1rem; border-collapse:collapse; font-size:0.9rem;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>Date</th>
            <th>Tool</th>
            <th>Language</th>
            <th>Tokens Used</th>
          </tr>
        </thead>
        <tbody id="credit-log-body">
          <tr><td colspan="4">Loading...</td></tr>
        </tbody>
      </table>
      <button class="btn-secondary" onclick="downloadAllOutputs()">Download All Outputs (ZIP)</button>
    </div>
  </main>

  <script>
    // --- Tabs ---
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    function logout() {
      localStorage.removeItem('userEmail');
      window.location.href = '../index.html';
    }

    function getLanguage() {
      return document.getElementById('language-select')?.value || 'en';
    }

    function addToHistory(tool, text) {
      const h = document.getElementById('session-history');
      const div = document.createElement('div');
      div.textContent = `[${tool}] ${text.substring(0, 100)}...`;
      h.appendChild(div);
    }

    // --- AI Agent ---
    async function generateResponse() {
      const input = document.getElementById('input-text').value.trim();
      if (!input) return alert("Please paste text first.");
      const out = document.getElementById('ai-output');
      out.style.display = 'block';
      out.innerHTML = `<div class="spinner"></div> Generating...`;

      try {
        const res = await fetch('/.netlify/functions/generate-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: localStorage.getItem('userEmail'),
            inputText: input,
            language: getLanguage()
          })
        });
        const data = await res.json();
        if (res.ok && data.draft) {
          out.textContent = data.draft;
          document.getElementById('confidence-meter').innerText = "Confidence: High";
          addToHistory("ai-agent", data.draft);
        } else out.textContent = data.error || "Failed.";
      } catch (e) {
        console.error(e);
        out.textContent = "Error generating.";
      }
    }

    // --- Claim Analysis Tools ---
    async function runTool(tool) {
      const out = document.getElementById(`${tool}-output`);
      const actions = document.getElementById(`${tool}-actions`);
      out.style.display = 'block';
      out.innerHTML = `<div class="spinner"></div> Generating...`;
      actions.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/generate-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: localStorage.getItem('userEmail'),
            mode: tool,
            language: getLanguage(),
            inputText: `Please generate output for tool: ${tool}`
          })
        });
        const data = await res.json();

        if (res.ok && data.draft) {
          out.textContent = data.draft;
          actions.style.display = 'flex';
          addToHistory(tool, data.draft);
        } else {
          out.textContent = data.error || "Failed to generate output.";
        }
      } catch (err) {
        console.error(err);
        out.textContent = "Error generating output.";
      }
    }

    function copyToolOutput(tool) {
      const text = document.getElementById(`${tool}-output`).innerText.trim();
      if (!text) return alert("No content to copy.");
      navigator.clipboard.writeText(text)
        .then(() => alert("Copied to clipboard!"))
        .catch(err => {
          console.error("Copy failed:", err);
          alert("Failed to copy.");
        });
    }

    function downloadToolOutput(tool) {
      const text = document.getElementById(`${tool}-output`).innerText.trim();
      if (!text) return alert("No content to download.");
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${tool}-output.txt`;
      link.click();
    }

    function clearOutput(tool) {
      document.getElementById(`${tool}-output`).textContent = '';
      document.getElementById(`${tool}-actions`).style.display = 'none';
    }

    function exportDoc(type) {
      fetch('/.netlify/functions/export-doc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: localStorage.getItem('userEmail'),
          type,
          content: document.getElementById('ai-output').innerText
        })
      })
      .then(res => res.blob())
      .then(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `AI-Response.${type}`;
        link.click();
      })
      .catch(err => console.error("Export failed:", err));
    }

    // --- Save Draft ---
    function saveDraft() {
      const text = document.getElementById('ai-output').innerText;
      if (!text) return alert("No draft.");
      fetch('/.netlify/functions/save-draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: localStorage.getItem('userEmail'), content: text })
      })
      .then(() => alert("Draft saved."))
      .catch(err => console.error("Save failed:", err));
    }

    // --- My Documents ---
    const lang = localStorage.getItem("lang") || "en";

    async function getSignedUrl(filePath) {
      const res = await fetch('/.netlify/functions/getSignedUrl', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filePath })
      });

      const data = await res.json();
      return data.url;
    }

    async function openDocument(filePath) {
      const url = await getSignedUrl(filePath);
      if (url) {
        window.open(url, "_blank");
      } else {
        alert("Failed to load document");
      }
    }

    async function loadDocuments() {
      try {
        const res = await fetch(`/docs/${localStorage.getItem("lang") || "en"}/documents.json`);
        if (!res.ok) throw new Error(`Failed to fetch: ${res.status}`);

        const docs = await res.json();
        const container = document.getElementById("documents-container");
        container.innerHTML = "";

        Object.values(docs).forEach(doc => {
          const card = document.createElement("div");
          card.className = "tool-card";
          card.innerHTML = `
            <div class="tool-title">${doc.label}</div>
            <div class="tool-desc">${doc.description || "Insurance Document"}</div>
            <div class="action-buttons">
              <button class="btn-primary" onclick="openDocument('${doc.templatePath}')">Template</button>
              <button class="btn-secondary" onclick="openDocument('${doc.samplePath}')">Sample</button>
            </div>
          `;
          container.appendChild(card);
        });

        if (Object.keys(docs).length === 0) {
          container.innerHTML = `<p>No documents found.</p>`;
        }
      } catch (err) {
        console.error("Error loading documents:", err);
        document.getElementById("documents-container").innerHTML =
          `<p style="color:red;">Failed to load documents.</p>`;
      }
    }

    function setLang(newLang) {
      localStorage.setItem("lang", newLang);
      loadDocuments();
    }

    async function deleteDocument(id, fileName) {
      if (!confirm("Delete this document?")) return;
      try {
        await fetch('/.netlify/functions/delete-document', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, fileName, email: localStorage.getItem('userEmail') })
        });
        loadDocuments();
      } catch (err) {
        console.error("Delete failed:", err);
      }
    }

    function uploadDocument() {
      const file = document.getElementById('doc-upload').files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("email", localStorage.getItem('userEmail'));
      fetch('/.netlify/functions/classify-upload', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(() => {
          alert("Document uploaded & classified");
          loadDocuments();
        })
        .catch(err => console.error("Upload failed:", err));
    }

    async function downloadDocument(filePath) {
      try {
        const response = await fetch('/.netlify/functions/generate-signed-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fileName: filePath,
            email: localStorage.getItem('userEmail')
          })
        });

        const data = await response.json();
        if (response.ok && data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || "Download failed. Please try again.");
        }
      } catch (err) {
        console.error("Download error:", err);
        alert("Error downloading file.");
      }
    }

    function downloadAllOutputs() {
      fetch('/.netlify/functions/download-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: localStorage.getItem('userEmail') })
      })
      .then(res => res.blob())
      .then(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'All-Outputs.zip';
        link.click();
      })
      .catch(err => console.error("Download all failed:", err));
    }

    // --- Credit Log ---
    async function loadCreditLog() {
      try {
        const res = await fetch('/.netlify/functions/get-credit-log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: localStorage.getItem('userEmail') })
        });
        const data = await res.json();
        const tbody = document.getElementById('credit-log-body');
        tbody.innerHTML = "";
        if (res.ok && data.success && data.logs.length > 0) {
          data.logs.forEach(log => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${new Date(log.created_at).toLocaleString()}</td>
              <td>${log.mode}</td>
              <td>${log.language}</td>
              <td>${log.tokens_used ?? "-"}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="4">No logs found.</td></tr>`;
        }
      } catch (err) {
        console.error("Error loading credit log:", err);
        document.getElementById('credit-log-body').innerHTML =
          `<tr><td colspan="4">Error loading log.</td></tr>`;
      }
    }

    // --- Playbook Progress ---
    async function savePlaybookProgress(phase, tasks) {
      try {
        await fetch("/.netlify/functions/save-playbook-progress", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: localStorage.getItem("userEmail"),
            phase,
            tasks
          })
        });
      } catch (err) {
        console.error("Failed to save playbook progress:", err);
      }
    }

    async function loadPlaybookProgress() {
      try {
        const res = await fetch("/.netlify/functions/get-playbook-progress", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: localStorage.getItem("userEmail") })
        });

        const data = await res.json();
        if (res.ok && data.success) {
          data.progress.forEach(({ phase, tasks }) => {
            Object.entries(tasks).forEach(([i, checked]) => {
              const checkbox = document.querySelector(`#${phase} input[data-task-index="${i}"]`);
              if (checkbox) checkbox.checked = checked;
            });
          });
        }
        updateProgressTracker();
      } catch (err) {
        console.error("Failed to load playbook progress:", err);
      }
    }

    function handleTaskChange(checkbox) {
      const phase = checkbox.dataset.phase;
      const allTasks = {};
      document.querySelectorAll(`#${phase} input[type="checkbox"]`).forEach(cb => {
        allTasks[cb.dataset.taskIndex] = cb.checked;
      });
      savePlaybookProgress(phase, allTasks);
      updateProgressTracker();
    }

    function updateProgressTracker() {
      const checkboxes = document.querySelectorAll('#claim-playbook input[type="checkbox"]');
      const total = checkboxes.length;
      let completed = 0;
      checkboxes.forEach(cb => { if (cb.checked) completed++; });
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

      document.getElementById('progress-label').textContent = `Progress: ${percent}%`;
      document.getElementById('progress-count').textContent = `${completed} / ${total} tasks`;
      document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    // --- Accordion + Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadPlaybookProgress();
      loadCreditLog();
      loadDocuments();
      document.querySelectorAll('.accordion-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const item = btn.parentElement;
          item.classList.toggle('active');
        });
      });
    });
  </script>
</body>
</html>
