<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response Center - ClaimNavigatorAI</title>
  <meta name="description" content="AI-powered claim response center with document library, AI response generation, and estimate tools.">

  <style>
    /* keep all your existing CSS exactly as-is */
    .response-input {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .response-output {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-light);
      font-size: 1rem;
      white-space: pre-wrap;
      margin-top: 1rem;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    .btn-primary:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }
    .action-buttons {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav>
        <div class="logo">ClaimNavigatorAI</div>
        <div class="nav-links">
          <a href="../index.html">Home</a>
          <a href="../product.html">Product</a>
          <a href="response-center.html">Response Center</a>
          <a href="settings.html">Settings</a>
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Response Center</h1>
        <p>AI-powered tools to strengthen your claim and generate professional responses</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('ai-agent')">AI Response & Analysis Agent</button>
        <button class="tab" onclick="switchTab('my-documents')">My Documents</button>
        <button class="tab" onclick="switchTab('estimate-tools')">Estimate Tools</button>
        <button class="tab" onclick="switchTab('settings')">Settings</button>
      </div>

      <!-- AI Response & Analysis Agent -->
      <div id="ai-agent" class="tab-content active">
        <h2>AI Response & Analysis Agent</h2>
        <p>Paste or upload your insurer correspondence below to generate a professional AI-powered reply.</p>

        <textarea id="input-text" class="response-input" placeholder="Paste your denial letter, insurer email, or claim text here..."></textarea>
        
        <button id="generate-btn" class="btn-primary">Generate AI Response</button>

        <div id="output-container" style="display:none;">
          <h3 style="margin-top:1.5rem;">AI Draft</h3>
          <div id="ai-output" class="response-output"></div>
          <div class="action-buttons">
            <button class="btn-primary" onclick="copyResponse()">Copy</button>
            <button class="btn-primary" onclick="downloadResponse()">Download</button>
          </div>
        </div>
      </div>

      <!-- My Documents -->
      <div id="my-documents" class="tab-content">
        <h2>Document Library</h2>
        <div id="credits-banner">
          <span>AI Responses Available:</span>
          <span id="credits-count">Loading...</span>
        </div>
        <div id="documents-container" style="display:none;"></div>
      </div>

      <!-- Estimate Tools -->
      <div id="estimate-tools" class="tab-content">
        <h2>Estimate Tools</h2>
        <p>Use AI-powered tools to calculate rough order of magnitude and reserve inquiries.</p>
      </div>

      <!-- Settings -->
      <div id="settings" class="tab-content">
        <h2>Settings</h2>
        <p>Manage your account, update preferences, and view usage history.</p>
      </div>
    </div>
  </main>

  <script>
    let userCredits = 0;

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem('userEmail');
        window.location.href = '../index.html';
      }
    }

    async function loadEntitlement() {
      try {
        const response = await fetch('/.netlify/functions/verify-entitlement', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: localStorage.getItem('userEmail') })
        });
        const data = await response.json();
        if (response.ok && data.credits !== undefined) {
          userCredits = data.credits;
          document.getElementById('credits-count').textContent = userCredits;
        } else {
          document.getElementById('credits-count').textContent = '0';
        }
      } catch (err) {
        console.error('Entitlement fetch error:', err);
        document.getElementById('credits-count').textContent = '0';
      }
    }

    async function generateResponse() {
      const btn = document.getElementById('generate-btn');
      const inputText = document.getElementById('input-text').value.trim();
      if (!inputText) {
        alert("Please paste some text first.");
        return;
      }
      if (userCredits <= 0) {
        alert("You have no credits left. Please purchase a top-up.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Generating...";

      try {
        const res = await fetch('/.netlify/functions/generate-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: localStorage.getItem('userEmail'),
            inputText
          })
        });

        const data = await res.json();

        if (res.ok && data.draft) {
          document.getElementById('ai-output').textContent = data.draft;
          document.getElementById('output-container').style.display = 'block';
          userCredits = data.credits_remaining;
          document.getElementById('credits-count').textContent = userCredits;
        } else {
          alert(data.error || "Failed to generate response.");
        }
      } catch (err) {
        console.error("AI Response error:", err);
        alert("Error generating response.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Generate AI Response";
      }
    }

    function copyResponse() {
      const text = document.getElementById('ai-output').textContent;
      navigator.clipboard.writeText(text);
      alert("Copied to clipboard!");
    }

    function downloadResponse() {
      const text = document.getElementById('ai-output').textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'AI-Response.txt';
      link.click();
    }

    async function loadDocuments() {
      try {
        const response = await fetch('../assets/data/documents.json');
        if (!response.ok) throw new Error('Failed to fetch documents');
        const documents = await response.json();
        renderDocuments(documents);
      } catch (err) {
        console.error('Error loading documents:', err);
      }
    }

    function renderDocuments(documents) {
      const container = document.getElementById('documents-container');
      let html = '<div class="document-grid">';
      Object.values(documents).forEach(doc => {
        html += `
          <div class="document-card">
            <div class="document-title">${doc.label}</div>
            <div class="document-description">${doc.description}</div>
            <div class="document-actions">
              <button class="btn-secondary" onclick="downloadDocument('${doc.templatePath}')">Download Template</button>
              ${doc.samplePath ? `<button class="btn-secondary" onclick="downloadDocument('${doc.samplePath}')">Download Sample</button>` : ''}
            </div>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
      container.style.display = 'block';
    }

    async function downloadDocument(filePath) {
      try {
        const response = await fetch('/.netlify/functions/generate-signed-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileName: filePath, email: localStorage.getItem('userEmail') })
        });
        const data = await response.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Download failed. Please try again.');
        }
      } catch (err) {
        console.error('Download error:', err);
        alert('Error downloading file.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadEntitlement();
      loadDocuments();
      document.getElementById('generate-btn').addEventListener('click', generateResponse);
    });
  </script>
</body>
</html>
