<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response Center - ClaimNavigatorAI</title>
  <meta name="description" content="AI-powered claim response center with document library, AI response generation, and estimate tools.">
  <style>
    /* Keep all your CSS as-is (unchanged) */
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">ClaimNavigatorAI</div>
        <div class="nav-links">
          <a href="../index.html">Home</a>
          <a href="../product.html">Product</a>
          <a href="response-center.html">Response Center</a>
          <a href="settings.html">Settings</a>
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Response Center</h1>
        <p>AI-powered tools to strengthen your claim and generate professional responses</p>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('new-response')">New Response</button>
        <button class="tab" onclick="switchTab('my-documents')">My Documents</button>
        <button class="tab" onclick="switchTab('estimate-tools')">Estimate Tools</button>
        <button class="tab" onclick="switchTab('settings')">Settings</button>
      </div>

      <div id="my-documents" class="tab-content active">
        <h2>Document Library</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">Download professional claim documents and templates.</p>
        <div id="documents-loading" class="loading"><div class="spinner"></div><p>Loading documents...</p></div>
        <div id="documents-error" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
          <p>Unable to load documents at this time. Please try again later.</p>
          <button class="btn-primary" onclick="loadDocuments()" style="margin-top: 1rem;">Retry</button>
        </div>
        <div id="documents-container" style="display: none;"></div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Init Supabase client
    const supabase = createClient(
      "SUPABASE_URL",        // replace with your Supabase project URL
      "SUPABASE_ANON_KEY"    // replace with your Supabase anon key
    );

    let currentUserEmail = null;

    async function initUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        currentUserEmail = user.email;
        console.log("Logged in as:", currentUserEmail);
      } else {
        alert("You must log in first.");
      }
    }

    // Secure download
    async function downloadDocument(fileName) {
      if (!currentUserEmail) {
        alert("No user logged in.");
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/generate-signed-url", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fileName, userEmail: currentUserEmail })
        });

        if (res.status === 200) {
          const { url } = await res.json();
          window.location.href = url;
        } else {
          const msg = await res.text();
          alert(msg);
        }
      } catch (err) {
        console.error(err);
        alert("Error downloading file.");
      }
    }

    // Load documents
    async function loadDocuments() {
      const loading = document.getElementById('documents-loading');
      const error = document.getElementById('documents-error');
      const container = document.getElementById('documents-container');

      loading.classList.add('active');
      error.style.display = 'none';
      container.style.display = 'none';

      try {
        const response = await fetch('../assets/data/documents.json');
        if (!response.ok) throw new Error('Failed to fetch documents');

        const documents = await response.json();
        renderDocuments(documents);

        loading.classList.remove('active');
        container.style.display = 'block';
      } catch (err) {
        console.error('Error loading documents:', err);
        loading.classList.remove('active');
        error.style.display = 'block';
      }
    }

    // Render documents with download buttons
    function renderDocuments(documents) {
      const container = document.getElementById('documents-container');
      let html = '<div class="document-grid">';
      Object.values(documents).forEach(doc => {
        html += `
          <div class="document-card">
            <div class="document-title">${doc.label}</div>
            <div class="document-description">${doc.description}</div>
            <div class="document-actions">
              <button onclick="downloadDocument('${doc.templatePath}')" class="btn-secondary">Download Template</button>
              ${doc.samplePath ? `<button onclick="downloadDocument('${doc.samplePath}')" class="btn-secondary">Download Sample</button>` : ''}
            </div>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
      initUser();
      loadDocuments();
    });
  </script>
</body>
</html>
