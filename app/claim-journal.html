<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Claim Journal • ClaimNavigatorAI</title>
  <link rel="stylesheet" href="/app/assets/css/style.css">
  <link rel="stylesheet" href="/app/assets/css/design-system.css">
  <link rel="stylesheet" href="/app/assets/css/resource-center.css">
  <script src="/app/assets/js/analytics.js"></script>
  <script src="/app/assets/js/activation.js"></script>
</head>
<body class="resource-center journal-page">
  <header class="header">
    <div class="bar container">
      <div class="brand"><div class="logo"></div><div>Claim Navigation AI</div></div>
      <nav class="nav">
        <a href="/app/index.html">Home</a>
        <span class="nav-separator">></span>
        <span class="nav-current">Claim Journal</span>
        <span class="nav-separator">></span>
        <a href="/app/resource-center.html">Resource Center</a>
      </nav>
    </div>
  </header>

  <div class="journal-breadcrumb">
    <div class="journal-shell">
      <a href="/app/resource-center/claim-roadmap.html" class="journal-link">← Back to Claim Roadmap</a>
      <span class="roadmap-stage-label journal-stage-label"></span>
    </div>
  </div>

  <section class="journal-hero">
    <div class="journal-shell">
      <div class="journal-hero-content">
        <div class="journal-hero-text">
          <h1>Claim Journal</h1>
          <p>Record events, track communication, and generate a clean claim timeline instantly.</p>
        </div>
        <div class="journal-hero-actions">
          <button class="journal-button primary" id="add-btn" type="button">Start New Entry</button>
          <button class="journal-button secondary" id="refresh-btn" type="button">Refresh Feed</button>
        </div>
      </div>
    </div>
  </section>

  <section class="journal-dashboard-section">
    <div class="journal-shell">
      <div class="journal-dashboard">
        <div class="journal-left">
          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Create New Journal Entry</p>
                <h2>New Entry</h2>
                <p class="journal-subtext">Capture the latest call, update, or submission. Timestamps are attached automatically.</p>
              </div>
              <span class="journal-meta">Auto timestamped</span>
            </div>
            <form id="add-form" class="journal-form" onsubmit="submitAddEntry(event)">
              <label for="entry-title">Entry title</label>
              <input type="text" id="entry-title" name="entry-title" placeholder="e.g. Call with adjuster about roof damage" required>
              <label for="entry-body">Details</label>
              <textarea id="entry-body" name="entry-body" placeholder="Summarize the event, agreements, next steps, or questions." required></textarea>
              <div class="journal-form-actions">
                <button type="submit" class="journal-button primary" aria-label="Save journal entry">Save Entry</button>
                <button type="button" class="journal-button ghost" aria-label="Clear entry fields" onclick="document.getElementById('add-form').reset();">Clear</button>
              </div>
            </form>
          </div>

          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Attach Evidence</p>
                <h2>Upload files</h2>
                <p class="journal-subtext">Link documents, photos, or statements to your journal.</p>
              </div>
            </div>
            <div class="journal-upload">
              <label class="journal-dropzone" for="evidence-upload">
                <div class="journal-drop-icon">&uarr;</div>
                <div>
                  <p class="journal-drop-title">Drag &amp; drop files or browse</p>
                  <p class="journal-drop-helper">PDF, JPG, PNG, DOCX up to 25MB</p>
                </div>
              </label>
              <input type="file" id="evidence-upload" multiple class="journal-file-input" aria-label="Upload evidence files">
              <p class="journal-helper-text">Evidence will align to the selected entry for quick reference.</p>
            </div>
          </div>

          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">AI Categorization</p>
                <h2>Insights</h2>
              </div>
            </div>
            <div class="journal-tag-grid">
              <div class="journal-insight-block">
                <p class="journal-label">Tags</p>
                <div class="journal-pill-row">
                  <span class="journal-pill">Inspection</span>
                  <span class="journal-pill">Follow-up</span>
                  <span class="journal-pill">Evidence</span>
                </div>
              </div>
              <div class="journal-insight-block">
                <p class="journal-label">Risk signals</p>
                <ul class="journal-list">
                  <li>Delayed adjuster response flagged</li>
                  <li>Evidence pending for roof photos</li>
                </ul>
              </div>
              <div class="journal-insight-block">
                <p class="journal-label">Claim stage inference</p>
                <p class="journal-subtext">Negotiation prep underway - ensure counter-offer evidence is organized.</p>
              </div>
            </div>
          </div>

          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Quick actions</p>
                <h2>Shortcuts</h2>
              </div>
            </div>
            <div class="journal-quick-actions">
              <button class="journal-button tertiary" type="button">Add to Timeline</button>
              <button class="journal-button tertiary" type="button">Trigger Deadline Scan</button>
              <a class="journal-button tertiary" href="/app/evidence-organizer.html">Link to Evidence Organizer</a>
            </div>
          </div>
        </div>

        <div class="journal-right">
          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Activity Feed</p>
                <h2>Journal Timeline Feed</h2>
              </div>
              <button class="journal-button tertiary" type="button" id="refresh-btn-secondary">Refresh</button>
            </div>
            <ul class="journal-entries" id="entries">
              <li class="journal-empty-state">Loading entries...</li>
            </ul>
          </div>

          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">AI Categorized Tags</p>
                <h2>Label Clusters</h2>
              </div>
            </div>
            <div class="journal-pill-section">
              <div class="journal-pill-row">
                <span class="journal-pill">Adjuster Contact</span>
                <span class="journal-pill">Payment Status</span>
                <span class="journal-pill">Docs Pending</span>
                <span class="journal-pill">Inspection</span>
              </div>
            </div>
          </div>

          <div class="journal-card">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Claim History Summarizer</p>
                <h2>Snapshot</h2>
              </div>
            </div>
            <div class="journal-stat-grid">
              <div class="journal-stat">
                <p>Total entries</p>
                <strong id="journal-total-entries">&mdash;</strong>
              </div>
              <div class="journal-stat">
                <p>Last updated</p>
                <strong id="journal-last-updated">&mdash;</strong>
              </div>
              <div class="journal-stat">
                <p>Key milestones</p>
                <strong>Auto-detected</strong>
              </div>
            </div>
            <ul class="journal-list">
              <li>Submission confirmed with carrier</li>
              <li>Initial estimate received</li>
              <li>Supplemental evidence requested</li>
            </ul>
          </div>

          <div class="journal-card journal-export">
            <div class="journal-card-header">
              <div>
                <p class="journal-kicker">Export Options</p>
                <h2>PDF Export</h2>
              </div>
            </div>
            <div class="journal-export-actions">
              <button class="journal-button primary" type="button">Export Full Journal as PDF</button>
              <button class="journal-button secondary" type="button">Export Last 30 Days</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    const claim_id = localStorage.getItem('claim_id') || new URLSearchParams(window.location.search).get('claim_id') || 'TEST-CLAIM';

    async function refresh() {
      try {
        const res = await fetch(`/.netlify/functions/get-journal?claim_id=${claim_id}`);
        const data = await res.json();

        if (data.status === 'error') {
          throw new Error(data.error);
        }

        const entries = data.entries || [];
        const entriesList = document.getElementById('entries');

        if (entries.length === 0) {
          entriesList.innerHTML = '<li class="journal-empty-state">No journal entries yet. Click "Save Entry" to get started.</li>';
        } else {
          entriesList.innerHTML = entries.map(entry => {
            const date = new Date(entry.created_at);
            const dateStr = date.toLocaleDateString();
            const timeStr = date.toLocaleTimeString();
            
            return `
              <li class="journal-entry">
                <div class="journal-entry-header">
                  <h4 class="journal-entry-title">${entry.entry_title}</h4>
                  <span class="journal-entry-date">${dateStr} at ${timeStr}</span>
                </div>
                <p class="journal-entry-body">${entry.entry_body}</p>
              </li>
            `;
          }).join('');
        }

        const totalEl = document.getElementById('journal-total-entries');
        const lastUpdatedEl = document.getElementById('journal-last-updated');
        if (totalEl) {
          totalEl.textContent = entries.length ? entries.length : '0';
        }
        if (lastUpdatedEl) {
          let latestDate = null;
          entries.forEach(entry => {
            const created = new Date(entry.created_at);
            if (!latestDate || created > latestDate) {
              latestDate = created;
            }
          });
          lastUpdatedEl.textContent = latestDate ? latestDate.toLocaleDateString() : '--';
        }

      } catch (error) {
        console.error('Error refreshing:', error);
        document.getElementById('entries').innerHTML = 
          `<li class="journal-empty-state">Error loading entries: ${error.message}</li>`;
      }
    }

    async function submitAddEntry(event) {
      event.preventDefault();
      
      const entryData = {
        claim_id: claim_id,
        user_id: localStorage.getItem('user_id') || null,
        entry_title: document.getElementById('entry-title').value,
        entry_body: document.getElementById('entry-body').value
      };

      try {
        const res = await fetch('/.netlify/functions/add-journal-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entryData)
        });

        const data = await res.json();
        
        if (data.status === 'error') {
          throw new Error(data.error);
        }

        refresh();
        
        // Mark activation milestone
        if (window.markActivation) {
          markActivation("claim_journal_entry");
        }
      } catch (error) {
        alert('Error adding entry: ' + error.message);
      }
    }

    // Event listeners
    document.getElementById('add-btn').addEventListener('click', () => {
      document.getElementById('entry-title').focus();
    });
    document.getElementById('refresh-btn').addEventListener('click', refresh);
    const refreshSecondary = document.getElementById('refresh-btn-secondary');
    if (refreshSecondary) {
      refreshSecondary.addEventListener('click', refresh);
    }

    // Initial load
    refresh();
  </script>
  
  <script>
    // Roadmap stage label
    const params = new URLSearchParams(window.location.search);
    const stage = params.get('stage');
    const labelMap = {
      "1": "Stage 1 · Start Your Claim",
      "2": "Stage 2 · Document Damage",
      "3": "Stage 3 · Analyze & Compare",
      "4": "Stage 4 · Submit & Respond",
      "5": "Stage 5 · Negotiate",
      "6": "Stage 6 · Resolve or Escalate"
    };
    const labelEl = document.querySelector(".roadmap-stage-label");
    if (labelEl) {
      labelEl.textContent = labelMap[stage] || "";
    }
  </script>
    <script type="module" src="/app/assets/js/tools/claim-journal.js"></script>
</body>
</html>


